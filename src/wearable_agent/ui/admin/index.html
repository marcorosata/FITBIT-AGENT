<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wearable Agent — Admin Dashboard</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #242736;
  --surface3: #2d3143;
  --border: #2e3245;
  --text: #e4e6f0;
  --text2: #8b8fa3;
  --text3: #5a5e73;
  --accent: #6c5ce7;
  --accent-light: #a29bfe;
  --success: #00b894;
  --success-dim: rgba(0,184,148,.15);
  --warning: #fdcb6e;
  --warning-dim: rgba(253,203,110,.15);
  --danger: #e17055;
  --danger-dim: rgba(225,112,85,.15);
  --critical: #d63031;
  --critical-dim: rgba(214,48,49,.15);
  --info: #74b9ff;
  --info-dim: rgba(116,185,255,.15);
  --inbound: #00cec9;
  --inbound-dim: rgba(0,206,201,.12);
  --outbound: #fd79a8;
  --outbound-dim: rgba(253,121,168,.12);
  --radius: 12px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}
a { color: var(--accent-light); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ── Layout ─────────────────────────────────────────────── */
.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 2rem;
  display: flex;
  align-items: center;
  height: 56px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.topbar h1 { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: .5rem; }
.topbar h1 span { color: var(--accent-light); }
.topbar .right { margin-left: auto; display: flex; align-items: center; gap: 1.25rem; }
.topbar .status { display: flex; align-items: center; gap: .5rem; font-size: .82rem; color: var(--text2); }
.topbar .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); transition: background .3s; }
.topbar .dot.online { background: var(--success); animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }

.shell { display: grid; grid-template-columns: 210px 1fr; min-height: calc(100vh - 56px); }

/* ── Sidebar ─────────────────────────────────────────────── */
.sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 1rem 0;
  overflow-y: auto;
}
.sidebar .nav-label { padding: .4rem 1.25rem; font-size: .68rem; text-transform: uppercase; letter-spacing: .08em; color: var(--text3); margin-top: .8rem; }
.sidebar .nav-item {
  display: flex; align-items: center; gap: .55rem;
  padding: .55rem 1.25rem; font-size: .85rem; color: var(--text2);
  cursor: pointer; transition: all .15s; border-left: 3px solid transparent;
}
.sidebar .nav-item:hover { color: var(--text); background: var(--surface2); }
.sidebar .nav-item.active { color: var(--accent-light); background: rgba(108,92,231,.08); border-left-color: var(--accent); }

/* ── Main ────────────────────────────────────────────────── */
.main { padding: 1.5rem 2rem; overflow-y: auto; max-height: calc(100vh - 56px); }
.page { display: none; }
.page.active { display: block; }
.page-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 1.25rem; display: flex; align-items: center; gap: .5rem; }

/* ── Stat cards ──────────────────────────────────────────── */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: .75rem; margin-bottom: 1.25rem; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem 1.15rem; }
.stat-card .label { font-size: .75rem; color: var(--text2); margin-bottom: .15rem; text-transform: uppercase; letter-spacing: .04em; }
.stat-card .number { font-size: 1.7rem; font-weight: 700; line-height: 1.2; }
.stat-card .sub { font-size: .72rem; color: var(--text3); margin-top: .15rem; }
.stat-card.inbound { border-left: 3px solid var(--inbound); }
.stat-card.outbound { border-left: 3px solid var(--outbound); }
.stat-card.clients { border-left: 3px solid var(--accent); }
.stat-card.alerts-stat { border-left: 3px solid var(--warning); }

/* ── Cards ───────────────────────────────────────────────── */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.25rem; }
.card-title { font-size: .95rem; font-weight: 600; margin-bottom: .75rem; display: flex; align-items: center; gap: .5rem; }
.card-title .sub { font-size: .75rem; color: var(--text2); margin-left: auto; font-weight: 400; }

/* ── Split stream panels ─────────────────────────────────── */
.stream-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem; }
@media (max-width: 1100px) { .stream-grid { grid-template-columns: 1fr; } }

.stream-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.stream-panel.inbound { border-top: 3px solid var(--inbound); }
.stream-panel.outbound { border-top: 3px solid var(--outbound); }

.stream-header { padding: .75rem 1.15rem; display: flex; align-items: center; gap: .5rem; border-bottom: 1px solid var(--border); }
.stream-header .icon { font-size: 1.1rem; }
.stream-header .title { font-size: .9rem; font-weight: 600; }
.stream-header .count { margin-left: auto; font-size: .78rem; color: var(--text2); font-variant-numeric: tabular-nums; }

.stream-body { max-height: 400px; overflow-y: auto; font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace; font-size: .76rem; }
.stream-body::-webkit-scrollbar { width: 6px; }
.stream-body::-webkit-scrollbar-track { background: transparent; }
.stream-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.stream-entry { padding: .4rem 1rem; border-bottom: 1px solid rgba(255,255,255,.03); display: flex; gap: .75rem; align-items: baseline; transition: background .15s; }
.stream-entry:hover { background: var(--surface2); }
.stream-entry .ts { color: var(--text3); min-width: 75px; font-size: .72rem; }
.stream-entry .tag { min-width: 72px; font-size: .68rem; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
.stream-entry .msg { color: var(--text); word-break: break-word; }

.tag-reading { color: var(--inbound); }
.tag-alert { color: var(--warning); }
.tag-affect { color: #a29bfe; }
.tag-system { color: var(--text2); }
.tag-heart_rate { color: #e17055; }
.tag-steps { color: #00b894; }
.tag-sleep { color: #6c5ce7; }
.tag-spo2 { color: #74b9ff; }
.tag-hrv { color: #fdcb6e; }
.tag-calories { color: #fd79a8; }

/* ── Live chart ──────────────────────────────────────────── */
.chart-container { position: relative; height: 120px; margin: .75rem 0; }
.chart-canvas { width: 100%; height: 100%; }
.chart-label { position: absolute; top: 4px; right: 8px; font-size: .68rem; color: var(--text3); }

/* ── Connection grid ─────────────────────────────────────── */
.conn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: .5rem; }
.conn-chip {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
  padding: .6rem .9rem; text-align: center;
}
.conn-chip .ch-name { font-size: .78rem; color: var(--text2); text-transform: capitalize; }
.conn-chip .ch-count { font-size: 1.3rem; font-weight: 700; margin-top: .1rem; }

/* ── Tables ──────────────────────────────────────────────── */
table { width: 100%; border-collapse: collapse; font-size: .82rem; }
th { text-align: left; padding: .5rem .65rem; font-weight: 600; color: var(--text2); border-bottom: 1px solid var(--border); font-size: .72rem; text-transform: uppercase; letter-spacing: .04em; }
td { padding: .5rem .65rem; border-bottom: 1px solid rgba(255,255,255,.04); }
tr:hover { background: var(--surface2); }

/* ── Badges ──────────────────────────────────────────────── */
.badge { display: inline-block; padding: .12rem .5rem; border-radius: 999px; font-size: .7rem; font-weight: 600; text-transform: uppercase; }
.badge-info { background: var(--info-dim); color: var(--info); }
.badge-warning { background: var(--warning-dim); color: var(--warning); }
.badge-critical { background: var(--critical-dim); color: var(--critical); }
.badge-success { background: var(--success-dim); color: var(--success); }
.badge-inbound { background: var(--inbound-dim); color: var(--inbound); }
.badge-outbound { background: var(--outbound-dim); color: var(--outbound); }

/* ── Forms ───────────────────────────────────────────────── */
.form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: .75rem; margin-bottom: .75rem; }
.form-group { display: flex; flex-direction: column; gap: .25rem; }
.form-group label { font-size: .78rem; color: var(--text2); }
input, select, textarea {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
  padding: .5rem .7rem; color: var(--text); font-size: .85rem; font-family: inherit; outline: none; transition: border .15s;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); }
textarea { resize: vertical; min-height: 70px; }
.btn {
  display: inline-flex; align-items: center; gap: .4rem; padding: .5rem 1.1rem;
  border: none; border-radius: 8px; font-size: .82rem; font-weight: 600; cursor: pointer; transition: all .15s; font-family: inherit;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #5b4bd5; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #c0392b; }
.btn-sm { padding: .3rem .65rem; font-size: .75rem; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text2); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent-light); }

/* ── Agent chat ──────────────────────────────────────────── */
.chat-box { background: var(--surface2); border-radius: var(--radius); padding: 1rem; max-height: 380px; overflow-y: auto; font-size: .85rem; white-space: pre-wrap; line-height: 1.7; }
.chat-input-row { display: flex; gap: .75rem; }
.chat-input-row input { flex: 1; }

/* ── Filter bar ──────────────────────────────────────────── */
.filter-bar { display: flex; gap: .5rem; margin-bottom: .75rem; flex-wrap: wrap; }
.filter-chip {
  padding: .3rem .7rem; border-radius: 999px; font-size: .72rem; font-weight: 600;
  border: 1px solid var(--border); cursor: pointer; transition: all .15s; color: var(--text2);
  text-transform: uppercase; letter-spacing: .03em; user-select: none;
}
.filter-chip:hover { border-color: var(--accent); color: var(--text); }
.filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

/* ── Responsive ──────────────────────────────────────────── */
@media (max-width: 768px) {
  .shell { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .stream-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ── Top bar ────────────────────────────────────────────── -->
<div class="topbar">
  <h1>&#x1FA7A; <span>Wearable Agent</span> &mdash; Admin</h1>
  <div class="right">
    <div class="status">
      <div class="dot" id="status-dot"></div>
      <span id="status-text">Connecting&hellip;</span>
    </div>
    <span style="font-size:.75rem;color:var(--text3)" id="ws-status">WS: &mdash;</span>
  </div>
</div>

<div class="shell">

<!-- ── Sidebar ─────────────────────────────────────────────── -->
<nav class="sidebar">
  <div class="nav-label">Streaming</div>
  <div class="nav-item active" data-page="streams">&#x1F4E1; Live Streams</div>
  <div class="nav-item" data-page="dashboard">&#x1F4CA; Dashboard</div>
  <div class="nav-label">Data</div>
  <div class="nav-item" data-page="readings">&#x1F4C8; Readings</div>
  <div class="nav-item" data-page="alerts">&#x1F514; Alerts</div>
  <div class="nav-label">Management</div>
  <div class="nav-item" data-page="rules">&#x2699;&#xFE0F; Rules</div>
  <div class="nav-item" data-page="ingest">&#x1F4E5; Ingest Data</div>
  <div class="nav-item" data-page="participants">&#x1F465; Participants</div>
  <div class="nav-label">Intelligence</div>
  <div class="nav-item" data-page="agent">&#x1F916; Agent Chat</div>
</nav>

<!-- ── Main content ────────────────────────────────────────── -->
<div class="main">

  <!-- ════════════════════════════════════════════════════════
       STREAMS — Primary view: incoming Fitbit & outgoing to App
       ════════════════════════════════════════════════════════ -->
  <div class="page active" id="page-streams">
    <div class="page-title">&#x1F4E1; Live Streaming Monitor</div>

    <!-- KPI row -->
    <div class="stats-row">
      <div class="stat-card inbound">
        <div class="label">Inbound (Fitbit)</div>
        <div class="number" id="st-inbound">0</div>
        <div class="sub"><span id="st-inbound-rate">0</span> /sec</div>
      </div>
      <div class="stat-card outbound">
        <div class="label">Outbound (to App)</div>
        <div class="number" id="st-outbound">0</div>
        <div class="sub"><span id="st-outbound-rate">0</span> /sec</div>
      </div>
      <div class="stat-card clients">
        <div class="label">WS Clients</div>
        <div class="number" id="st-clients">0</div>
        <div class="sub">connected now</div>
      </div>
      <div class="stat-card alerts-stat">
        <div class="label">Alerts Fired</div>
        <div class="number" id="st-alerts-fired">0</div>
        <div class="sub">this session</div>
      </div>
    </div>

    <!-- Throughput mini-chart -->
    <div class="card">
      <div class="card-title">&#x26A1; Throughput
        <span class="sub">messages/sec &mdash; last 60 seconds</span>
      </div>
      <div class="chart-container">
        <canvas id="throughput-chart" class="chart-canvas"></canvas>
        <span class="chart-label">
          <span style="color:var(--inbound)">&#x25A0;</span> Inbound
          <span style="color:var(--outbound);margin-left:.5rem">&#x25A0;</span> Outbound
        </span>
      </div>
    </div>

    <!-- Channel connections -->
    <div class="card">
      <div class="card-title">&#x1F50C; Channel Subscriptions
        <span class="sub" id="conn-update-time">&mdash;</span>
      </div>
      <div class="conn-grid" id="channel-grid">
        <div class="conn-chip"><div class="ch-name">all</div><div class="ch-count">0</div></div>
        <div class="conn-chip"><div class="ch-name">readings</div><div class="ch-count">0</div></div>
        <div class="conn-chip"><div class="ch-name">alerts</div><div class="ch-count">0</div></div>
        <div class="conn-chip"><div class="ch-name">affect</div><div class="ch-count">0</div></div>
        <div class="conn-chip"><div class="ch-name">system</div><div class="ch-count">0</div></div>
      </div>
    </div>

    <!-- Split stream panels -->
    <div class="stream-grid">
      <!-- Inbound from Fitbit -->
      <div class="stream-panel inbound">
        <div class="stream-header">
          <span class="icon">&#x2B07;&#xFE0F;</span>
          <span class="title" style="color:var(--inbound)">Incoming from Fitbit</span>
          <span class="count" id="inbound-count">0 messages</span>
        </div>
        <div class="stream-body" id="inbound-log">
          <div class="stream-entry"><span class="ts">--:--:--</span><span class="msg" style="color:var(--text3)">Waiting for Fitbit data&hellip;</span></div>
        </div>
      </div>

      <!-- Outbound to App -->
      <div class="stream-panel outbound">
        <div class="stream-header">
          <span class="icon">&#x2B06;&#xFE0F;</span>
          <span class="title" style="color:var(--outbound)">Outgoing to Flutter App</span>
          <span class="count" id="outbound-count">0 messages</span>
        </div>
        <div class="stream-body" id="outbound-log">
          <div class="stream-entry"><span class="ts">--:--:--</span><span class="msg" style="color:var(--text3)">Waiting for broadcasts&hellip;</span></div>
        </div>
      </div>
    </div>

    <!-- Unified live log with filters -->
    <div class="card">
      <div class="card-title">&#x1F4CB; Unified Event Log
        <span class="sub" id="log-total">0 events</span>
      </div>
      <div class="filter-bar">
        <span class="filter-chip active" data-filter="all">All</span>
        <span class="filter-chip" data-filter="reading">Readings</span>
        <span class="filter-chip" data-filter="alert">Alerts</span>
        <span class="filter-chip" data-filter="affect">Affect</span>
        <span class="filter-chip" data-filter="system">System</span>
        <span class="filter-chip" data-filter="inbound">Inbound</span>
        <span class="filter-chip" data-filter="outbound">Outbound</span>
      </div>
      <div class="stream-body" id="unified-log" style="max-height:320px">
        <div class="stream-entry"><span class="ts">--:--:--</span><span class="msg" style="color:var(--text3)">Waiting for events&hellip;</span></div>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════
       DASHBOARD — Overview stats
       ════════════════════════════════════════════════════════ -->
  <div class="page" id="page-dashboard">
    <div class="page-title">&#x1F4CA; Dashboard</div>
    <div class="stats-row">
      <div class="stat-card">
        <div class="label">Total Readings</div>
        <div class="number" id="stat-readings">&mdash;</div>
        <div class="sub">all participants</div>
      </div>
      <div class="stat-card">
        <div class="label">Active Alerts</div>
        <div class="number" id="stat-alerts">&mdash;</div>
        <div class="sub">all time</div>
      </div>
      <div class="stat-card">
        <div class="label">Monitoring Rules</div>
        <div class="number" id="stat-rules">&mdash;</div>
        <div class="sub">active</div>
      </div>
      <div class="stat-card">
        <div class="label">Pipeline Pending</div>
        <div class="number" id="stat-pipeline">&mdash;</div>
        <div class="sub">queued items</div>
      </div>
    </div>

    <!-- System info -->
    <div class="card">
      <div class="card-title">&#x1F5A5; System Status</div>
      <div id="system-info" style="font-size:.85rem; color:var(--text2)">Loading&hellip;</div>
    </div>

    <div class="card">
      <div class="card-title">&#x1F4CB; Recent Alerts</div>
      <table>
        <thead><tr><th>Time</th><th>Participant</th><th>Metric</th><th>Value</th><th>Severity</th><th>Message</th></tr></thead>
        <tbody id="dash-alerts-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════
       READINGS
       ════════════════════════════════════════════════════════ -->
  <div class="page" id="page-readings">
    <div class="page-title">&#x1F4C8; Sensor Readings</div>
    <div class="card">
      <div class="form-row">
        <div class="form-group"><label>Participant ID</label><input id="rd-participant" value="P001"></div>
        <div class="form-group"><label>Metric</label>
          <select id="rd-metric">
            <option value="heart_rate">Heart Rate</option><option value="steps">Steps</option>
            <option value="sleep">Sleep</option><option value="spo2">SpO2</option>
            <option value="hrv">HRV</option><option value="calories">Calories</option>
          </select>
        </div>
        <div class="form-group"><label>Limit</label><input id="rd-limit" type="number" value="50" min="1" max="1000"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-primary" onclick="loadReadings()">&#x1F50D; Query</button></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Results <span class="sub" id="readings-stats"></span></div>
      <div style="overflow-x:auto">
        <table><thead><tr><th>Timestamp</th><th>Value</th><th>Unit</th><th>Device</th></tr></thead>
        <tbody id="readings-body"></tbody></table>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════
       ALERTS
       ════════════════════════════════════════════════════════ -->
  <div class="page" id="page-alerts">
    <div class="page-title">&#x1F514; Alerts</div>
    <div class="card">
      <div class="form-row">
        <div class="form-group"><label>Participant ID</label><input id="al-participant" value="P001"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-primary" onclick="loadAlerts()">&#x1F50D; Load</button></div>
      </div>
    </div>
    <div class="card">
      <table><thead><tr><th>Time</th><th>Severity</th><th>Metric</th><th>Value</th><th>Message</th></tr></thead>
      <tbody id="alerts-body"></tbody></table>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════
       RULES
       ════════════════════════════════════════════════════════ -->
  <div class="page" id="page-rules">
    <div class="page-title">&#x2699;&#xFE0F; Monitoring Rules</div>
    <div class="card">
      <div class="card-title">&#x2795; Add New Rule</div>
      <div class="form-row">
        <div class="form-group"><label>Metric</label>
          <select id="rule-metric"><option value="heart_rate">Heart Rate</option><option value="steps">Steps</option><option value="sleep">Sleep</option><option value="spo2">SpO2</option><option value="hrv">HRV</option></select>
        </div>
        <div class="form-group"><label>Condition</label><input id="rule-condition" placeholder="e.g. value > 120"></div>
        <div class="form-group"><label>Severity</label>
          <select id="rule-severity"><option value="info">Info</option><option value="warning" selected>Warning</option><option value="critical">Critical</option></select>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:.75rem"><label>Message Template</label><input id="rule-message" value="Metric {metric_type} value {value} breached rule."></div>
      <button class="btn btn-primary" onclick="addRule()">Add Rule</button>
    </div>
    <div class="card">
      <div class="card-title">&#x1F4DD; Active Rules</div>
      <table><thead><tr><th>ID</th><th>Metric</th><th>Condition</th><th>Severity</th><th>Message</th><th></th></tr></thead>
      <tbody id="rules-body"></tbody></table>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════
       INGEST
       ════════════════════════════════════════════════════════ -->
  <div class="page" id="page-ingest">
    <div class="page-title">&#x1F4E5; Ingest Data</div>
    <div class="card">
      <div class="card-title">Manual Data Entry</div>
      <div class="form-row">
        <div class="form-group"><label>Participant ID</label><input id="ing-participant" value="P001"></div>
        <div class="form-group"><label>Device</label>
          <select id="ing-device"><option value="fitbit">Fitbit</option><option value="apple_watch">Apple Watch</option><option value="garmin">Garmin</option><option value="generic">Generic</option></select>
        </div>
        <div class="form-group"><label>Metric</label>
          <select id="ing-metric"><option value="heart_rate">Heart Rate</option><option value="steps">Steps</option><option value="sleep">Sleep</option><option value="spo2">SpO2</option><option value="hrv">HRV</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Value</label><input id="ing-value" type="number" step="0.1" placeholder="72"></div>
        <div class="form-group"><label>Unit</label><input id="ing-unit" value="bpm"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-primary" onclick="ingestData()">&#x1F4E4; Submit</button></div>
      </div>
      <div id="ingest-result" style="margin-top:.5rem; font-size:.82rem;"></div>
    </div>
    <div class="card">
      <div class="card-title">&#x1F4E6; Batch Ingest (JSON)</div>
      <textarea id="ing-batch" rows="5" placeholder='[{"participant_id":"P001","device_type":"fitbit","metric_type":"heart_rate","value":72,"unit":"bpm"}]'></textarea>
      <div style="margin-top:.5rem"><button class="btn btn-primary" onclick="ingestBatch()">&#x1F4E4; Submit Batch</button></div>
      <div id="batch-result" style="margin-top:.5rem; font-size:.82rem;"></div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════
       PARTICIPANTS
       ════════════════════════════════════════════════════════ -->
  <div class="page" id="page-participants">
    <div class="page-title">&#x1F465; Participants</div>
    <div class="card">
      <div class="card-title">Known Participants</div>
      <div id="participants-list" style="color:var(--text2); font-size:.85rem;">Loading&hellip;</div>
    </div>
    <div class="card">
      <div class="card-title">&#x1F52C; Participant Evaluation</div>
      <div class="form-row">
        <div class="form-group"><label>Participant ID</label><input id="eval-participant" value="P001"></div>
        <div class="form-group"><label>Metric</label><select id="eval-metric"><option value="heart_rate">Heart Rate</option><option value="steps">Steps</option></select></div>
        <div class="form-group"><label>Hours</label><input id="eval-hours" type="number" value="24" min="1" max="168"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-primary" onclick="evaluateParticipant()">&#x1F916; Evaluate</button></div>
      </div>
      <div id="eval-result" class="chat-box" style="display:none"></div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════
       AGENT CHAT
       ════════════════════════════════════════════════════════ -->
  <div class="page" id="page-agent">
    <div class="page-title">&#x1F916; Agent Chat</div>
    <div class="card">
      <p style="color:var(--text2); font-size:.82rem; margin-bottom:.75rem">
        Ask the LLM agent research questions. It can query data, compute statistics, and reason about anomalies.
      </p>
      <div class="chat-box" id="chat-messages"><em style="color:var(--text3)">No messages yet. Ask a question below.</em></div>
      <div class="chat-input-row" style="margin-top:.75rem">
        <input id="chat-input" placeholder="e.g. Summarise P001's heart rate for the last 24h" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-primary" onclick="sendChat()">Send</button>
      </div>
    </div>
  </div>

</div><!-- .main -->
</div><!-- .shell -->

<script>
/* ═══════════════════════════════════════════════════════════
   ADMIN DASHBOARD — JavaScript
   ═══════════════════════════════════════════════════════════ */

const API = '';  // same origin

// ── State ─────────────────────────────────────────────────────
let ws = null;
let wsConnected = false;
let inboundMessages = [];
let outboundMessages = [];
let allMessages = [];
let alertsFiredCount = 0;
let activeFilter = 'all';

// Throughput chart data (60 data points = 1 per second)
const CHART_LEN = 60;
let inboundRates = new Array(CHART_LEN).fill(0);
let outboundRates = new Array(CHART_LEN).fill(0);
let inboundBucket = 0;
let outboundBucket = 0;

// ── Navigation ────────────────────────────────────────────────
document.querySelectorAll('.nav-item').forEach(function(item) {
  item.addEventListener('click', function() {
    document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
    document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
    item.classList.add('active');
    document.getElementById('page-' + item.dataset.page).classList.add('active');
  });
});

// Filter chips
document.querySelectorAll('.filter-chip').forEach(function(chip) {
  chip.addEventListener('click', function() {
    document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
    chip.classList.add('active');
    activeFilter = chip.dataset.filter;
    renderUnifiedLog();
  });
});

// ── Helpers ───────────────────────────────────────────────────
async function api(method, path, body) {
  var opts = { method: method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  var r = await fetch(API + path, opts);
  if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
  return r.json();
}

function fmtTime(iso) { return new Date(iso).toLocaleTimeString(); }
function fmtDate(iso) { return new Date(iso).toLocaleString(); }
function nowTime() { return new Date().toLocaleTimeString(); }
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function severityBadge(s) {
  var cls = s === 'critical' ? 'badge-critical' : s === 'warning' ? 'badge-warning' : 'badge-info';
  return '<span class="badge ' + cls + '">' + s + '</span>';
}

// ── WebSocket Connection ──────────────────────────────────────
function connectWS() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var url = proto + '//' + location.host + '/ws/stream?channel=all';
  ws = new WebSocket(url);

  ws.onopen = function() {
    wsConnected = true;
    document.getElementById('status-dot').className = 'dot online';
    document.getElementById('status-text').textContent = 'Online';
    document.getElementById('ws-status').textContent = 'WS: Connected';
    document.getElementById('ws-status').style.color = 'var(--success)';
    addUnified('system', 'outbound', 'Admin dashboard connected via WebSocket');
  };

  ws.onmessage = function(event) {
    try {
      var msg = JSON.parse(event.data);
      handleWSMessage(msg);
    } catch(e) { console.warn('WS parse error', e); }
  };

  ws.onclose = function() {
    wsConnected = false;
    document.getElementById('status-dot').className = 'dot';
    document.getElementById('status-text').textContent = 'Disconnected';
    document.getElementById('ws-status').textContent = 'WS: Reconnecting\u2026';
    document.getElementById('ws-status').style.color = 'var(--warning)';
    setTimeout(connectWS, 3000);
  };

  ws.onerror = function() {
    document.getElementById('ws-status').textContent = 'WS: Error';
    document.getElementById('ws-status').style.color = 'var(--danger)';
  };
}

function handleWSMessage(msg) {
  var ts = nowTime();
  var type = msg.type || 'unknown';
  var data = msg.data || {};

  if (type === 'reading') {
    var metric = data.metric_type || '?';
    var summary = (data.participant_id || '?') + ' ' + metric + ' = ' + (data.value != null ? data.value : '?') + ' ' + (data.unit || '');

    // Track as both inbound (from Fitbit) and outbound (to app clients)
    addInbound(ts, metric, summary, data);
    addOutbound(ts, 'reading', '\u2192 ' + summary, data);
    inboundBucket++;
    outboundBucket++;

  } else if (type === 'alert') {
    var summary = '\u26A0 ' + (data.participant_id || '?') + ' ' + (data.severity || '?') + ' \u2014 ' + (data.message || '?');
    addOutbound(ts, 'alert', summary, data);
    outboundBucket++;
    alertsFiredCount++;
    document.getElementById('st-alerts-fired').textContent = alertsFiredCount;

  } else if (type === 'affect') {
    var summary = '\uD83E\uDDE0 ' + (data.participant_id || '?') + ' affect inference';
    addOutbound(ts, 'affect', summary, data);
    outboundBucket++;

  } else if (type === 'system') {
    var summary = '\u2699 ' + (msg.event || 'system') + ': ' + JSON.stringify(data).slice(0, 80);
    addOutbound(ts, 'system', summary, data);
  }

  updateStreamCounts();
}

// ── Stream message buffers ────────────────────────────────────
var MAX_LOG = 300;

function addInbound(ts, metricType, summary, data) {
  inboundMessages.unshift({ ts: ts, type: metricType, summary: summary, data: data });
  if (inboundMessages.length > MAX_LOG) inboundMessages.pop();
  addUnified(metricType, 'inbound', summary, data);
  renderInboundLog();
}

function addOutbound(ts, msgType, summary, data) {
  outboundMessages.unshift({ ts: ts, type: msgType, summary: summary, data: data });
  if (outboundMessages.length > MAX_LOG) outboundMessages.pop();
  addUnified(msgType, 'outbound', summary, data);
  renderOutboundLog();
}

function addUnified(msgType, direction, summary, data) {
  allMessages.unshift({ ts: nowTime(), type: msgType, direction: direction, summary: summary, data: data });
  if (allMessages.length > MAX_LOG * 2) allMessages.length = MAX_LOG;
  document.getElementById('log-total').textContent = allMessages.length + ' events';
  renderUnifiedLog();
}

function updateStreamCounts() {
  document.getElementById('inbound-count').textContent = inboundMessages.length + ' messages';
  document.getElementById('outbound-count').textContent = outboundMessages.length + ' messages';
}

// ── Renderers ─────────────────────────────────────────────────
function renderInboundLog() {
  var el = document.getElementById('inbound-log');
  var html = inboundMessages.slice(0, 100).map(function(m) {
    return '<div class="stream-entry">' +
      '<span class="ts">' + m.ts + '</span>' +
      '<span class="tag tag-' + m.type + '">' + m.type + '</span>' +
      '<span class="msg">' + escHtml(m.summary) + '</span>' +
      '</div>';
  }).join('');
  el.innerHTML = html || '<div class="stream-entry"><span class="ts">--</span><span class="msg" style="color:var(--text3)">Waiting for Fitbit data\u2026</span></div>';
}

function renderOutboundLog() {
  var el = document.getElementById('outbound-log');
  var html = outboundMessages.slice(0, 100).map(function(m) {
    return '<div class="stream-entry">' +
      '<span class="ts">' + m.ts + '</span>' +
      '<span class="tag tag-' + m.type + '">' + m.type + '</span>' +
      '<span class="msg">' + escHtml(m.summary) + '</span>' +
      '</div>';
  }).join('');
  el.innerHTML = html || '<div class="stream-entry"><span class="ts">--</span><span class="msg" style="color:var(--text3)">Waiting for broadcasts\u2026</span></div>';
}

function renderUnifiedLog() {
  var el = document.getElementById('unified-log');
  var filtered = activeFilter === 'all'
    ? allMessages
    : allMessages.filter(function(m) { return m.type === activeFilter || m.direction === activeFilter; });

  var html = filtered.slice(0, 150).map(function(m) {
    var dirBadge = m.direction === 'inbound'
      ? '<span class="badge badge-inbound" style="font-size:.62rem">IN</span>'
      : '<span class="badge badge-outbound" style="font-size:.62rem">OUT</span>';
    return '<div class="stream-entry">' +
      '<span class="ts">' + m.ts + '</span>' +
      dirBadge +
      '<span class="tag tag-' + m.type + '">' + m.type + '</span>' +
      '<span class="msg">' + escHtml(m.summary || '') + '</span>' +
      '</div>';
  }).join('');
  el.innerHTML = html || '<div class="stream-entry"><span class="ts">--</span><span class="msg" style="color:var(--text3)">No events match filter.</span></div>';
}

// ── Throughput chart (Canvas) ─────────────────────────────────
function drawThroughputChart() {
  var canvas = document.getElementById('throughput-chart');
  if (!canvas) return;
  var dpr = window.devicePixelRatio || 1;
  var ctx = canvas.getContext('2d');
  var w = canvas.offsetWidth;
  var h = canvas.offsetHeight;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  ctx.clearRect(0, 0, w, h);

  // Grid lines
  ctx.strokeStyle = 'rgba(255,255,255,.06)';
  ctx.lineWidth = 1;
  for (var i = 0; i < 5; i++) {
    var gy = (h / 5) * i;
    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke();
  }

  var maxVal = Math.max(3, Math.max.apply(null, inboundRates), Math.max.apply(null, outboundRates)) * 1.2;
  var dx = w / (CHART_LEN - 1);

  function drawLine(data, color) {
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    for (var j = 0; j < CHART_LEN; j++) {
      var x = j * dx;
      var y = h - (data[j] / maxVal) * (h - 10);
      if (j === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Fill area
    ctx.lineTo((CHART_LEN - 1) * dx, h);
    ctx.lineTo(0, h);
    ctx.closePath();
    var parts = color.match(/\d+/g);
    ctx.fillStyle = 'rgba(' + parts[0] + ',' + parts[1] + ',' + parts[2] + ',.08)';
    ctx.fill();
  }

  drawLine(inboundRates, 'rgb(0,206,201)');
  drawLine(outboundRates, 'rgb(253,121,168)');
}

// Tick every second: shift chart data
setInterval(function() {
  inboundRates.push(inboundBucket);
  inboundRates.shift();
  outboundRates.push(outboundBucket);
  outboundRates.shift();
  inboundBucket = 0;
  outboundBucket = 0;
  drawThroughputChart();
}, 1000);

// ── Poll stream stats from server ─────────────────────────────
async function pollStreamStats() {
  try {
    var data = await api('GET', '/admin/api/stream-stats');

    document.getElementById('st-inbound').textContent = ((data.throughput && data.throughput.total_inbound) || 0).toLocaleString();
    document.getElementById('st-outbound').textContent = ((data.throughput && data.throughput.total_outbound) || 0).toLocaleString();
    document.getElementById('st-inbound-rate').textContent = ((data.throughput && data.throughput.inbound_rate_per_sec) || 0).toFixed(1);
    document.getElementById('st-outbound-rate').textContent = ((data.throughput && data.throughput.outbound_rate_per_sec) || 0).toFixed(1);
    document.getElementById('st-clients').textContent = (data.connections && data.connections.total) || 0;

    // Channel grid
    var channels = (data.connections && data.connections.channels) || {};
    var grid = document.getElementById('channel-grid');
    var allCh = ['all', 'readings', 'alerts', 'affect', 'system'];
    var gridHtml = allCh.map(function(ch) {
      return '<div class="conn-chip"><div class="ch-name">' + ch + '</div><div class="ch-count">' + (channels[ch] || 0) + '</div></div>';
    }).join('');
    // extra channels
    Object.keys(channels).forEach(function(ch) {
      if (allCh.indexOf(ch) === -1) {
        gridHtml += '<div class="conn-chip"><div class="ch-name">' + ch + '</div><div class="ch-count">' + channels[ch] + '</div></div>';
      }
    });
    grid.innerHTML = gridHtml;
    document.getElementById('conn-update-time').textContent = 'Updated ' + nowTime();

    // Seed unified log from server history if empty
    if (allMessages.length === 0 && data.recent_messages && data.recent_messages.length) {
      var reversed = data.recent_messages.slice().reverse();
      reversed.forEach(function(m) {
        addUnified(m.type, m.direction, m.summary);
      });
    }
  } catch(e) { /* silent */ }
}

// ── Dashboard ─────────────────────────────────────────────────
async function refreshDashboard() {
  try {
    var health = await api('GET', '/health');
    document.getElementById('stat-pipeline').textContent = health.pipeline_pending;
    if (!wsConnected) {
      document.getElementById('status-text').textContent = 'Online (polling)';
    }
  } catch(e) {
    document.getElementById('status-text').textContent = 'Offline';
    document.getElementById('status-dot').className = 'dot';
  }

  try {
    var rules = await api('GET', '/rules');
    document.getElementById('stat-rules').textContent = rules.length;
  } catch(e) {}

  try {
    var stats = await api('GET', '/api/stats');
    document.getElementById('stat-readings').textContent = stats.total_readings.toLocaleString();
    document.getElementById('stat-alerts').textContent = stats.total_alerts.toLocaleString();
    var alertsHtml = stats.recent_alerts.map(function(a) {
      return '<tr><td>' + fmtDate(a.timestamp) + '</td><td>' + a.participant_id + '</td><td>' + a.metric + '</td><td>' + a.value + '</td><td>' + severityBadge(a.severity) + '</td><td style="max-width:260px;overflow:hidden;text-overflow:ellipsis">' + a.message + '</td></tr>';
    }).join('');
    document.getElementById('dash-alerts-body').innerHTML = alertsHtml || '<tr><td colspan="6" style="color:var(--text3)">No recent alerts.</td></tr>';

    if (stats.participants && stats.participants.length) {
      document.getElementById('participants-list').innerHTML = stats.participants.map(function(p) {
        return '<span class="badge badge-info" style="margin:.2rem;cursor:pointer" onclick="document.getElementById(\'eval-participant\').value=\'' + p + '\'">' + p + '</span>';
      }).join('');
    }
  } catch(e) {}

  // System info
  try {
    var info = await api('GET', '/system/info');
    document.getElementById('system-info').innerHTML =
      '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.5rem">' +
        '<div>Pipeline: ' + (info.pipeline && info.pipeline.running ? '<span style="color:var(--success)">Running</span>' : '<span style="color:var(--danger)">Stopped</span>') + ' (' + ((info.pipeline && info.pipeline.pending) || 0) + ' pending)</div>' +
        '<div>Agent: ' + (info.agent && info.agent.ready ? '<span style="color:var(--success)">Ready</span>' : '<span style="color:var(--text3)">Not ready</span>') + '</div>' +
        '<div>Rules: ' + ((info.rule_engine && info.rule_engine.rule_count) || 0) + ' active</div>' +
        '<div>Scheduler: ' + (info.scheduler && info.scheduler.running ? '<span style="color:var(--success)">Running</span>' : '<span style="color:var(--text3)">Off</span>') + ' (' + ((info.scheduler && info.scheduler.interval_minutes) || '?') + 'm interval)</div>' +
        '<div>Affect: ' + (info.affect_pipeline && info.affect_pipeline.ready ? '<span style="color:var(--success)">Ready</span>' : '<span style="color:var(--text3)">Not ready</span>') + '</div>' +
        '<div>WS Clients: ' + ((info.websocket && info.websocket.connected_clients) || 0) + '</div>' +
      '</div>';
  } catch(e) {}
}

// ── Readings ──────────────────────────────────────────────────
async function loadReadings() {
  var pid = document.getElementById('rd-participant').value;
  var metric = document.getElementById('rd-metric').value;
  var limit = document.getElementById('rd-limit').value;
  try {
    var data = await api('GET', '/readings/' + pid + '?metric=' + metric + '&limit=' + limit);
    if (!data.length) {
      document.getElementById('readings-body').innerHTML = '<tr><td colspan="4" style="color:var(--text3)">No readings found.</td></tr>';
      document.getElementById('readings-stats').textContent = '';
      return;
    }
    var vals = data.map(function(r) { return r.value; });
    var sum = vals.reduce(function(a, b) { return a + b; }, 0);
    var mean = (sum / vals.length).toFixed(1);
    document.getElementById('readings-stats').textContent = data.length + ' rows \u2014 Mean: ' + mean + ' | Min: ' + Math.min.apply(null, vals).toFixed(1) + ' | Max: ' + Math.max.apply(null, vals).toFixed(1);
    document.getElementById('readings-body').innerHTML = data.map(function(r) {
      return '<tr><td>' + fmtDate(r.timestamp) + '</td><td><strong>' + r.value + '</strong></td><td>' + r.unit + '</td><td>' + r.device_type + '</td></tr>';
    }).join('');
  } catch(e) {
    document.getElementById('readings-body').innerHTML = '<tr><td colspan="4" style="color:var(--danger)">' + e.message + '</td></tr>';
  }
}

// ── Alerts ────────────────────────────────────────────────────
async function loadAlerts() {
  var pid = document.getElementById('al-participant').value;
  try {
    var data = await api('GET', '/alerts/' + pid);
    document.getElementById('alerts-body').innerHTML = data.length
      ? data.map(function(a) { return '<tr><td>' + fmtDate(a.timestamp) + '</td><td>' + severityBadge(a.severity) + '</td><td>' + a.metric + '</td><td>' + a.value + '</td><td>' + a.message + '</td></tr>'; }).join('')
      : '<tr><td colspan="5" style="color:var(--text3)">No alerts.</td></tr>';
  } catch(e) {
    document.getElementById('alerts-body').innerHTML = '<tr><td colspan="5" style="color:var(--danger)">' + e.message + '</td></tr>';
  }
}

// ── Rules ─────────────────────────────────────────────────────
async function loadRules() {
  try {
    var data = await api('GET', '/rules');
    document.getElementById('rules-body').innerHTML = data.map(function(r) {
      return '<tr><td style="font-family:monospace;font-size:.72rem">' + r.rule_id.slice(0, 8) + '\u2026</td><td>' + r.metric_type + '</td>' +
        '<td><code style="background:var(--surface2);padding:.1rem .4rem;border-radius:4px">' + r.condition + '</code></td>' +
        '<td>' + severityBadge(r.severity) + '</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">' + r.message_template + '</td>' +
        '<td><button class="btn btn-danger btn-sm" onclick="deleteRule(\'' + r.rule_id + '\')">\u2715</button></td></tr>';
    }).join('');
  } catch(e) {}
}
async function addRule() {
  await api('POST', '/rules', {
    metric_type: document.getElementById('rule-metric').value,
    condition: document.getElementById('rule-condition').value,
    severity: document.getElementById('rule-severity').value,
    message_template: document.getElementById('rule-message').value,
  });
  document.getElementById('rule-condition').value = '';
  loadRules();
}
async function deleteRule(id) { await api('DELETE', '/rules/' + id); loadRules(); }

// ── Ingest ────────────────────────────────────────────────────
async function ingestData() {
  try {
    var res = await api('POST', '/ingest', {
      participant_id: document.getElementById('ing-participant').value,
      device_type: document.getElementById('ing-device').value,
      metric_type: document.getElementById('ing-metric').value,
      value: parseFloat(document.getElementById('ing-value').value),
      unit: document.getElementById('ing-unit').value,
    });
    document.getElementById('ingest-result').innerHTML = '<span style="color:var(--success)">\u2713 Queued \u2014 ID: ' + res.id + '</span>';
  } catch(e) {
    document.getElementById('ingest-result').innerHTML = '<span style="color:var(--danger)">\u2715 ' + e.message + '</span>';
  }
}
async function ingestBatch() {
  try {
    var raw = JSON.parse(document.getElementById('ing-batch').value);
    var res = await api('POST', '/ingest/batch', raw);
    document.getElementById('batch-result').innerHTML = '<span style="color:var(--success)">\u2713 ' + res.count + ' readings queued</span>';
  } catch(e) {
    document.getElementById('batch-result').innerHTML = '<span style="color:var(--danger)">\u2715 ' + e.message + '</span>';
  }
}

// ── Agent ─────────────────────────────────────────────────────
var chatHist = [];
async function sendChat() {
  var input = document.getElementById('chat-input');
  var q = input.value.trim();
  if (!q) return;
  input.value = '';
  chatHist.push({ role: 'user', text: q });
  renderChat();
  var box = document.getElementById('chat-messages');
  box.innerHTML += '\n<em style="color:var(--text3)">Thinking\u2026</em>';
  box.scrollTop = box.scrollHeight;
  try {
    var res = await api('POST', '/analyse', { query: q });
    chatHist.push({ role: 'agent', text: res.response });
  } catch(e) {
    chatHist.push({ role: 'agent', text: '\u26A0\uFE0F Error: ' + e.message });
  }
  renderChat();
}
function renderChat() {
  var box = document.getElementById('chat-messages');
  box.innerHTML = chatHist.map(function(m) {
    return m.role === 'user'
      ? '<div style="color:var(--accent-light);margin:.4rem 0"><strong>You:</strong> ' + escHtml(m.text) + '</div>'
      : '<div style="margin:.4rem 0"><strong>\uD83E\uDD16 Agent:</strong>\n' + escHtml(m.text) + '</div>';
  }).join('') || '<em style="color:var(--text3)">No messages yet.</em>';
  box.scrollTop = box.scrollHeight;
}

// ── Participant Evaluation ────────────────────────────────────
async function evaluateParticipant() {
  var box = document.getElementById('eval-result');
  box.style.display = 'block';
  box.textContent = 'Evaluating\u2026 (may take a moment)';
  try {
    var pid = document.getElementById('eval-participant').value;
    var metric = document.getElementById('eval-metric').value;
    var hours = document.getElementById('eval-hours').value;
    var res = await api('GET', '/evaluate/' + pid + '?metric=' + metric + '&hours=' + hours);
    box.textContent = res.evaluation;
  } catch(e) {
    box.textContent = '\u26A0\uFE0F Error: ' + e.message;
  }
}

// ── Init ──────────────────────────────────────────────────────
connectWS();
refreshDashboard();
loadRules();
pollStreamStats();

setInterval(refreshDashboard, 15000);
setInterval(pollStreamStats, 3000);

// Initial chart draw
requestAnimationFrame(drawThroughputChart);
window.addEventListener('resize', drawThroughputChart);
</script>
</body>
</html>
