<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wearable Agent — Research Control Panel</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #242736;
  --surface3: #2d3143;
  --border: #2e3245;
  --text: #e4e6f0;
  --text2: #8b8fa3;
  --text3: #5a5e73;
  --accent: #6c5ce7;
  --accent-light: #a29bfe;
  --success: #00b894;
  --success-dim: rgba(0,184,148,.15);
  --warning: #fdcb6e;
  --warning-dim: rgba(253,203,110,.15);
  --danger: #e17055;
  --danger-dim: rgba(225,112,85,.15);
  --critical: #d63031;
  --critical-dim: rgba(214,48,49,.15);
  --info: #74b9ff;
  --info-dim: rgba(116,185,255,.15);
  --cardiac: #e17055;
  --respiratory: #74b9ff;
  --activity: #00b894;
  --sleep-c: #6c5ce7;
  --body: #fd79a8;
  --affect-c: #a29bfe;
  --radius: 12px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
a { color: var(--accent-light); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ── Layout ─────────────────────────────────── */
.topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 2rem; display: flex; align-items: center; height: 52px; position: sticky; top: 0; z-index: 100; }
.topbar h1 { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: .5rem; }
.topbar h1 span { color: var(--accent-light); }
.topbar .right { margin-left: auto; display: flex; align-items: center; gap: 1rem; }
.topbar .status { display: flex; align-items: center; gap: .4rem; font-size: .78rem; color: var(--text2); }
.topbar .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); transition: background .3s; }
.topbar .dot.online { background: var(--success); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

.shell { display: grid; grid-template-columns: 200px 1fr; min-height: calc(100vh - 52px); }

/* ── Sidebar ─────────────────────────────────── */
.sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: .75rem 0; overflow-y: auto; }
.sidebar .nav-label { padding: .35rem 1.15rem; font-size: .62rem; text-transform: uppercase; letter-spacing: .1em; color: var(--text3); margin-top: .6rem; }
.sidebar .nav-item {
  display: flex; align-items: center; gap: .5rem;
  padding: .5rem 1.15rem; font-size: .82rem; color: var(--text2);
  cursor: pointer; transition: all .15s; border-left: 3px solid transparent;
}
.sidebar .nav-item:hover { color: var(--text); background: var(--surface2); }
.sidebar .nav-item.active { color: var(--accent-light); background: rgba(108,92,231,.08); border-left-color: var(--accent); }

/* ── Main ─────────────────────────────────────── */
.main { padding: 1.5rem 2rem; overflow-y: auto; max-height: calc(100vh - 52px); }
.page { display: none; }
.page.active { display: block; }
.page-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: .5rem; }
.page-title .sub { font-size: .78rem; color: var(--text2); font-weight: 400; margin-left: .5rem; }

/* ── Stat cards ──────────────────────────────── */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: .65rem; margin-bottom: 1.15rem; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: .85rem 1rem; }
.stat-card .label { font-size: .7rem; color: var(--text2); margin-bottom: .1rem; text-transform: uppercase; letter-spacing: .04em; }
.stat-card .number { font-size: 1.6rem; font-weight: 700; line-height: 1.2; }
.stat-card .sub { font-size: .68rem; color: var(--text3); margin-top: .1rem; }

/* ── Cards ───────────────────────────────────── */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.15rem; margin-bottom: 1rem; }
.card-title { font-size: .92rem; font-weight: 600; margin-bottom: .65rem; display: flex; align-items: center; gap: .5rem; }
.card-title .sub { font-size: .72rem; color: var(--text2); margin-left: auto; font-weight: 400; }

/* ── Tables ──────────────────────────────────── */
table { width: 100%; border-collapse: collapse; font-size: .82rem; }
th { text-align: left; padding: .45rem .6rem; font-weight: 600; color: var(--text2); border-bottom: 1px solid var(--border); font-size: .7rem; text-transform: uppercase; letter-spacing: .04em; }
td { padding: .45rem .6rem; border-bottom: 1px solid rgba(255,255,255,.04); }
tr:hover { background: var(--surface2); }

/* ── Badges ──────────────────────────────────── */
.badge { display: inline-block; padding: .1rem .45rem; border-radius: 999px; font-size: .68rem; font-weight: 600; text-transform: uppercase; }
.badge-info { background: var(--info-dim); color: var(--info); }
.badge-warning { background: var(--warning-dim); color: var(--warning); }
.badge-critical { background: var(--critical-dim); color: var(--critical); }
.badge-success { background: var(--success-dim); color: var(--success); }

/* ── Forms ───────────────────────────────────── */
.form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: .65rem; margin-bottom: .65rem; }
.form-group { display: flex; flex-direction: column; gap: .2rem; }
.form-group label { font-size: .75rem; color: var(--text2); }
input, select, textarea {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
  padding: .45rem .65rem; color: var(--text); font-size: .84rem; font-family: inherit; outline: none; transition: border .15s;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); }
textarea { resize: vertical; min-height: 60px; }
.btn {
  display: inline-flex; align-items: center; gap: .35rem; padding: .45rem 1rem;
  border: none; border-radius: 8px; font-size: .82rem; font-weight: 600; cursor: pointer; transition: all .15s; font-family: inherit;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #5b4bd5; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #c0392b; }
.btn-sm { padding: .28rem .6rem; font-size: .74rem; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text2); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent-light); }
.btn-test { background: rgba(0,184,148,.12); border: 1px solid var(--success); color: var(--success); }
.btn-test:hover { background: rgba(0,184,148,.22); }

/* ── Filter bar ──────────────────────────────── */
.filter-bar { display: flex; gap: .4rem; margin-bottom: .65rem; flex-wrap: wrap; }
.filter-chip {
  padding: .25rem .6rem; border-radius: 999px; font-size: .7rem; font-weight: 600;
  border: 1px solid var(--border); cursor: pointer; transition: all .15s; color: var(--text2);
  text-transform: uppercase; letter-spacing: .03em; user-select: none;
}
.filter-chip:hover { border-color: var(--accent); color: var(--text); }
.filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

/* ── Modal overlay ───────────────────────────── */
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,.55); z-index: 200; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 1.25rem; width: 500px; max-width: 94vw; box-shadow: var(--shadow);
}
.modal-box .modal-title { font-size: .95rem; font-weight: 700; margin-bottom: .85rem; display: flex; align-items: center; gap: .5rem; }
.modal-box .modal-close { margin-left: auto; cursor: pointer; background: none; border: none; color: var(--text3); font-size: 1.1rem; }
.modal-box .modal-close:hover { color: var(--text); }
.modal-box .modal-actions { display: flex; gap: .5rem; justify-content: flex-end; margin-top: .85rem; }

/* ── Sensor metric cards ─────────────────────── */
.metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: .6rem; }
.metric-card {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
  padding: .75rem .95rem; border-left: 3px solid var(--text3); transition: border-color .2s;
}
.metric-card:hover { border-color: var(--accent); }
.metric-card .mc-header { display: flex; align-items: center; gap: .4rem; margin-bottom: .2rem; }
.metric-card .mc-label { font-weight: 700; font-size: .84rem; }
.metric-card .mc-key { font-size: .68rem; color: var(--text3); font-family: monospace; margin-left: auto; }
.metric-card .mc-desc { font-size: .74rem; color: var(--text2); line-height: 1.4; margin-bottom: .3rem; }
.metric-card .mc-meta { display: flex; gap: .8rem; font-size: .7rem; flex-wrap: wrap; }
.metric-card .mc-meta span { display: flex; gap: .2rem; }
.metric-card .mc-actions { display: flex; gap: .3rem; margin-top: .35rem; }
.mc-edit-btn {
  padding: .15rem .4rem; border-radius: 5px; font-size: .68rem; cursor: pointer;
  border: 1px solid transparent; background: transparent; color: var(--text3); transition: all .15s;
}
.mc-edit-btn:hover { border-color: var(--accent); color: var(--accent-light); background: rgba(108,92,231,.08); }

/* ── Tool cards ──────────────────────────────── */
.tool-card {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
  padding: .85rem 1rem; margin-bottom: .55rem; border-left: 3px solid var(--accent);
}
.tool-card .tc-header { display: flex; align-items: center; gap: .5rem; margin-bottom: .3rem; }
.tool-card .tc-name { font-weight: 700; color: var(--accent-light); font-family: monospace; font-size: .88rem; }
.tool-card .tc-desc { font-size: .78rem; color: var(--text2); line-height: 1.45; margin-bottom: .4rem; }
.tool-card .tc-params { display: flex; flex-wrap: wrap; gap: .2rem; }
.tool-card .tc-param {
  display: inline-block; padding: .12rem .45rem; background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; font-size: .7rem;
}
.tool-card .tc-param .pname { color: var(--accent-light); }
.tool-card .tc-param .ptype { color: var(--text3); margin-left: .2rem; }
.tool-card .tc-param .preq { color: var(--danger); margin-left: .15rem; }

/* ── Chat ────────────────────────────────────── */
.chat-box { background: var(--surface2); border-radius: var(--radius); padding: .85rem; max-height: 400px; overflow-y: auto; font-size: .84rem; white-space: pre-wrap; line-height: 1.7; }
.chat-input-row { display: flex; gap: .65rem; }
.chat-input-row input { flex: 1; }

/* ── Component status ────────────────────────── */
.comp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .5rem; }
.comp-chip {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
  padding: .55rem .8rem; display: flex; align-items: center; gap: .5rem;
}
.comp-chip .comp-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.comp-chip .comp-name { font-size: .8rem; font-weight: 600; }
.comp-chip .comp-detail { font-size: .68rem; color: var(--text3); margin-left: auto; }

/* ── Activity feed ───────────────────────────── */
.feed { max-height: 260px; overflow-y: auto; font-family: 'Cascadia Code','Fira Code','Consolas',monospace; font-size: .74rem; }
.feed::-webkit-scrollbar { width: 5px; }
.feed::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.feed-entry { padding: .3rem .8rem; border-bottom: 1px solid rgba(255,255,255,.03); display: flex; gap: .6rem; align-items: baseline; }
.feed-entry:hover { background: var(--surface2); }
.feed-entry .ts { color: var(--text3); min-width: 68px; font-size: .68rem; }
.feed-entry .tag { font-size: .66rem; font-weight: 600; text-transform: uppercase; min-width: 60px; }
.feed-entry .msg { color: var(--text); word-break: break-word; }

/* ── Live data table ─────────────────────────── */
.live-table-wrap { max-height: 320px; overflow-y: auto; }
.live-table-wrap::-webkit-scrollbar { width: 5px; }
.live-table-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.data-stat { text-align: center; }
.data-stat .ds-val { font-size: 1.4rem; font-weight: 700; line-height: 1.1; }
.data-stat .ds-label { font-size: .65rem; color: var(--text2); text-transform: uppercase; letter-spacing: .04em; }
.data-stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px,1fr)); gap: .5rem; padding: .65rem .85rem; background: var(--surface2); border-radius: 8px; margin-bottom: .85rem; }
.tab-bar { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: .85rem; }
.tab-btn { padding: .45rem 1rem; font-size: .8rem; font-weight: 600; cursor: pointer; background: none; border: none; color: var(--text3); border-bottom: 2px solid transparent; transition: all .15s; font-family: inherit; }
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--accent-light); border-bottom-color: var(--accent); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ── Test result ─────────────────────────────── */
.test-result { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: .75rem; font-family: monospace; font-size: .78rem; white-space: pre-wrap; max-height: 300px; overflow-y: auto; line-height: 1.5; }

/* ── Responsive ──────────────────────────────── */
@media (max-width: 768px) {
  .shell { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .metric-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ── Top bar ──────────────────────────────── -->
<div class="topbar">
  <h1>&#x1FA7A; <span>Wearable Agent</span> &#x2014; Research Panel</h1>
  <div class="right">
    <a href="/static/wearable-agent-app.apk" download style="display:flex;align-items:center;gap:.35rem;padding:.38rem .75rem;background:var(--accent);color:white;border-radius:6px;font-size:.76rem;font-weight:600;text-decoration:none">
      &#x1F4F1; App
    </a>
    <div class="status">
      <div class="dot" id="status-dot"></div>
      <span id="status-text">Connecting&hellip;</span>
    </div>
  </div>
</div>

<div class="shell">

<!-- ── Sidebar ──────────────────────────────── -->
<nav class="sidebar">
  <div class="nav-label">Research</div>
  <div class="nav-item active" data-page="overview">&#x1F3E0; Overview</div>
  <div class="nav-item" data-page="sensors">&#x1F4A0; Sensors &amp; Metrics</div>
  <div class="nav-label">Data</div>
  <div class="nav-item" data-page="data">&#x1F4CA; Data Management</div>
  <div class="nav-label">Monitoring</div>
  <div class="nav-item" data-page="rules">&#x1F6E1;&#xFE0F; Rules &amp; Alerts</div>
  <div class="nav-label">Intelligence</div>
  <div class="nav-item" data-page="tools">&#x1F9EA; Agent Tools</div>
  <div class="nav-item" data-page="chat">&#x1F916; Agent Chat</div>
</nav>

<!-- ── Main ─────────────────────────────────── -->
<div class="main">

<!-- ════════════════════════════════════════════
     OVERVIEW — Researcher command center
     ════════════════════════════════════════════ -->
<div class="page active" id="page-overview">
  <div class="page-title">&#x1F3E0; Overview</div>

  <div class="stats-row">
    <div class="stat-card" style="border-left:3px solid var(--accent)">
      <div class="label">Participants</div>
      <div class="number" id="ov-participants">&mdash;</div>
      <div class="sub">enrolled</div>
    </div>
    <div class="stat-card" style="border-left:3px solid var(--info)">
      <div class="label">Readings</div>
      <div class="number" id="ov-readings">&mdash;</div>
      <div class="sub">total stored</div>
    </div>
    <div class="stat-card" style="border-left:3px solid var(--warning)">
      <div class="label">Alerts</div>
      <div class="number" id="ov-alerts">&mdash;</div>
      <div class="sub">triggered</div>
    </div>
    <div class="stat-card" style="border-left:3px solid var(--success)">
      <div class="label">Rules</div>
      <div class="number" id="ov-rules">&mdash;</div>
      <div class="sub">active</div>
    </div>
    <div class="stat-card" style="border-left:3px solid var(--accent-light)">
      <div class="label">Agent Tools</div>
      <div class="number" id="ov-tools">&mdash;</div>
      <div class="sub">available</div>
    </div>
  </div>

  <!-- System components status -->
  <div class="card">
    <div class="card-title">&#x2699;&#xFE0F; System Components</div>
    <div class="comp-grid" id="ov-components">
      <div class="comp-chip"><span class="comp-dot" style="background:var(--text3)"></span><span class="comp-name">Loading&hellip;</span></div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="card">
    <div class="card-title">&#x26A1; Quick Actions</div>
    <div style="display:flex;flex-wrap:wrap;gap:.5rem;">
      <button class="btn btn-primary" onclick="goTo('collection')">&#x1F4E1; Start Data Stream</button>
      <button class="btn btn-outline" onclick="goTo('sensors')">&#x1F4A0; View Sensors</button>
      <button class="btn btn-outline" onclick="goTo('rules')">&#x1F6E1;&#xFE0F; Add Rule</button>
      <button class="btn btn-outline" onclick="goTo('tools')">&#x1F9EA; Test Agent Tool</button>
      <button class="btn btn-outline" onclick="goTo('chat')">&#x1F916; Agent Chat</button>
    </div>
  </div>

  <!-- Recent alerts -->
  <div class="card">
    <div class="card-title">&#x1F514; Recent Alerts <span class="sub" id="ov-alert-count"></span></div>
    <table>
      <thead><tr><th>Time</th><th>Participant</th><th>Metric</th><th>Value</th><th>Severity</th><th>Message</th></tr></thead>
      <tbody id="ov-alerts-body"><tr><td colspan="6" style="color:var(--text3)">Loading&hellip;</td></tr></tbody>
    </table>
  </div>
</div>

<!-- ════════════════════════════════════════════
     SENSORS & METRICS — Core researcher view
     ════════════════════════════════════════════ -->
<div class="page" id="page-sensors">
  <div class="page-title">&#x1F4A0; Sensors &amp; Metrics <span class="sub" id="sensor-count"></span></div>
  <p style="color:var(--text2);font-size:.82rem;margin-bottom:.75rem;">
    All physiological and behavioural metrics tracked by the framework. Click <strong>Edit</strong> to change labels, units, normal ranges, and descriptions. These values are used by the agent and rule engine.
  </p>

  <!-- Category filter -->
  <div class="filter-bar" id="sensor-filter-bar">
    <span class="filter-chip active" data-sensor-cat="all">All</span>
    <span class="filter-chip" data-sensor-cat="cardiac">Cardiac</span>
    <span class="filter-chip" data-sensor-cat="respiratory">Respiratory</span>
    <span class="filter-chip" data-sensor-cat="activity">Activity</span>
    <span class="filter-chip" data-sensor-cat="sleep">Sleep</span>
    <span class="filter-chip" data-sensor-cat="body">Body</span>
    <span class="filter-chip" data-sensor-cat="affect">Affect</span>
  </div>

  <div class="metric-grid" id="sensor-grid">
    <div style="color:var(--text3)">Loading sensor data&hellip;</div>
  </div>
</div>

<!-- ════════════════════════════════════════════
     DATA MANAGEMENT — Unified data interface
     ════════════════════════════════════════════ -->
<div class="page" id="page-data">
  <div class="page-title">&#x1F4CA; Data Management</div>

  <!-- Stream control (always visible) -->
  <div class="card" style="border-left:3px solid var(--accent)">
    <div class="card-title">&#x1F3AE; Start Data Stream <span class="sub" id="stream-status-label">Idle</span></div>
    <div class="form-row">
      <div class="form-group">
        <label>Data Source</label>
        <select id="stream-source" onchange="onStreamSourceChange()">
          <option value="dataset">&#x1F4C1; LifeSnaps Dataset</option>
          <option value="live">&#x1F4F1; Live Fitbit</option>
        </select>
      </div>
      <div class="form-group">
        <label>Participant ID</label>
        <div style="display:flex;gap:.35rem">
          <select id="stream-participant" style="flex:1"></select>
          <button class="btn btn-outline btn-sm" onclick="loadLifeSnapsParticipants()" title="Load available">&#x1F504;</button>
        </div>
      </div>
      <div class="form-group" id="stream-speed-group">
        <label>Speed</label>
        <select id="stream-speed">
          <option value="1">1x (real-time)</option>
          <option value="10" selected>10x</option>
          <option value="50">50x</option>
          <option value="100">100x</option>
        </select>
      </div>
      <div class="form-group" style="justify-content:flex-end">
        <button class="btn btn-primary" id="stream-start-btn" onclick="startDataStream()">&#x25B6; Start Stream</button>
      </div>
    </div>
    <div id="stream-participants-hint" style="margin-top:.35rem;font-size:.72rem;color:var(--text3);display:none">
      <strong>Available:</strong> <span id="stream-participants-list"></span>
    </div>
    <div id="stream-result" style="margin-top:.4rem;font-size:.82rem;"></div>
  </div>

  <!-- Tab bar -->
  <div class="card" style="padding-bottom:0">
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchDataTab('feed')">&#x1F4CB; Activity Feed</button>
      <button class="tab-btn" onclick="switchDataTab('live')">&#x1F4F2; Live Data to App</button>
      <button class="tab-btn" onclick="switchDataTab('media')">&#x1F3A5; Media</button>
      <button class="tab-btn" onclick="switchDataTab('ingest')">&#x1F4E5; Ingest Data</button>
      <button class="tab-btn" onclick="switchDataTab('query')">&#x1F50D; Query &amp; Evaluate</button>
    </div>
  </div>

  <!-- ── TAB: Activity Feed ─────────────────── -->
  <div class="tab-panel active" id="tab-feed">
    <div class="card">
      <div class="card-title">&#x1F4CB; Live Activity Feed <span class="sub" id="feed-count">0 events</span></div>
      <div class="feed" id="live-feed">
        <div class="feed-entry"><span class="ts">--:--:--</span><span class="msg" style="color:var(--text3)">Waiting for data&hellip;</span></div>
      </div>
    </div>
  </div>

  <!-- ── TAB: Live Data to App ──────────────── -->
  <div class="tab-panel" id="tab-live">

  <!-- ── TAB: Media Upload ──────────────────── -->
  <div class="tab-panel" id="tab-media">
    <div class="card" style="border-left:3px solid #a29bfe">
      <div class="card-title">&#x1F3A5; Upload Audio / Video</div>
      <p style="color:var(--text2);font-size:.82rem;margin-bottom:.75rem;">
        Upload an audio recording or video file and link it to a participant. Supported: MP3, WAV, M4A, OGG, AAC, FLAC, MP4, MOV, AVI, MKV, WebM.
      </p>
      <div class="form-row">
        <div class="form-group">
          <label>Participant ID</label>
          <select id="media-participant"></select>
        </div>
        <div class="form-group">
          <label>Label / Description</label>
          <input id="media-label" placeholder="e.g. Morning interview, Stress recording&hellip;">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label>File</label>
          <input type="file" id="media-file" accept="audio/*,video/*,.mp3,.wav,.m4a,.ogg,.aac,.flac,.mp4,.mov,.avi,.mkv,.webm" style="font-size:.82rem">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <input id="media-notes" placeholder="Optional notes&hellip;">
        </div>
        <div class="form-group" style="justify-content:flex-end">
          <button class="btn btn-primary" id="media-upload-btn" onclick="uploadMedia()">&#x1F4E4; Upload</button>
        </div>
      </div>
      <div id="media-upload-result" style="margin-top:.4rem;font-size:.82rem;"></div>
    </div>

    <!-- Media Library -->
    <div class="card">
      <div class="card-title">&#x1F4DA; Media Library <span class="sub" id="media-count">0 files</span>
        <button class="btn btn-outline btn-sm" onclick="loadMediaLibrary()" style="margin-left:.5rem">&#x1F504; Refresh</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Type</th><th>Participant</th><th>Label</th><th>Filename</th><th>Size</th><th>Uploaded</th><th></th></tr></thead>
          <tbody id="media-body"><tr><td colspan="7" style="color:var(--text3)">No media uploaded yet.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ── TAB: Live Data to App (continued) ──── -->
    <!-- Throughput stats bar -->
    <div class="card" style="padding:.5rem .85rem">
      <div class="data-stats-bar">
        <div class="data-stat"><div class="ds-val" id="ds-readings" style="color:var(--accent-light)">0</div><div class="ds-label">Readings Sent</div></div>
        <div class="data-stat"><div class="ds-val" id="ds-alerts" style="color:#fdcb6e">0</div><div class="ds-label">Alerts Sent</div></div>
        <div class="data-stat"><div class="ds-val" id="ds-affect" style="color:#a29bfe">0</div><div class="ds-label">Affect Inferences</div></div>
        <div class="data-stat"><div class="ds-val" id="ds-rate" style="color:#00cec9">0</div><div class="ds-label">Readings / sec</div></div>
        <div class="data-stat"><div class="ds-val" id="ds-clients" style="color:#55efc4">-</div><div class="ds-label">Connected Clients</div></div>
        <div class="data-stat"><div class="ds-val" id="ds-server-rate" style="color:#74b9ff">-</div><div class="ds-label">Server Out/sec</div></div>
      </div>
    </div>

    <!-- Per-metric breakdown -->
    <div class="card">
      <div class="card-title">&#x1F4CA; Per-Metric Breakdown <span class="sub" id="metric-breakdown-count"></span></div>
      <div id="metric-breakdown" style="display:flex;flex-wrap:wrap;gap:.4rem;font-size:.78rem;">
        <span style="color:var(--text3)">No data yet. Start a stream to see metric counts.</span>
      </div>
    </div>

    <!-- Live readings table -->
    <div class="card">
      <div class="card-title">&#x1F4F1; Recent Data Sent to App <span class="sub" id="live-table-count">0 entries</span></div>
      <div class="live-table-wrap">
        <table>
          <thead><tr><th>Time</th><th>Participant</th><th>Metric</th><th>Value</th><th>Unit</th><th>Type</th></tr></thead>
          <tbody id="live-data-body"><tr><td colspan="6" style="color:var(--text3)">Waiting for data stream&hellip;</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ── TAB: Ingest Data ───────────────────── -->
  <div class="tab-panel" id="tab-ingest">
    <div class="card">
      <div class="card-title">&#x270F;&#xFE0F; Manual Data Entry</div>
      <div class="form-row">
        <div class="form-group"><label>Participant ID</label><select id="ing-participant"></select></div>
        <div class="form-group"><label>Device</label>
          <select id="ing-device"><option value="fitbit">Fitbit</option><option value="apple_watch">Apple Watch</option><option value="garmin">Garmin</option><option value="generic">Generic</option></select>
        </div>
        <div class="form-group"><label>Metric</label><select id="ing-metric"></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Value</label><input id="ing-value" type="number" step="0.1" placeholder="72"></div>
        <div class="form-group"><label>Unit</label><input id="ing-unit" value="bpm"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-primary" onclick="ingestData()">&#x1F4E4; Submit</button></div>
      </div>
      <div id="ingest-result" style="margin-top:.4rem;font-size:.82rem;"></div>
    </div>

    <div class="card">
      <div class="card-title">&#x1F4E6; Batch Ingest (JSON)</div>
      <textarea id="ing-batch" rows="4" placeholder='[{"participant_id":"P001","device_type":"fitbit","metric_type":"heart_rate","value":72,"unit":"bpm"}]'></textarea>
      <div style="margin-top:.4rem"><button class="btn btn-primary" onclick="ingestBatch()">&#x1F4E4; Submit Batch</button></div>
      <div id="batch-result" style="margin-top:.4rem;font-size:.82rem;"></div>
    </div>
  </div>

  <!-- ── TAB: Query & Evaluate ──────────────── -->
  <div class="tab-panel" id="tab-query">
    <div class="card">
      <div class="card-title">&#x1F4C8; Query Readings</div>
      <div class="form-row">
        <div class="form-group"><label>Participant ID</label><select id="rd-participant"></select></div>
        <div class="form-group"><label>Metric</label><select id="rd-metric"></select></div>
        <div class="form-group"><label>Limit</label><input id="rd-limit" type="number" value="50" min="1" max="1000"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-primary" onclick="loadReadings()">&#x1F50D; Query</button></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Results <span class="sub" id="readings-stats"></span></div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Timestamp</th><th>Value</th><th>Unit</th><th>Device</th></tr></thead>
          <tbody id="readings-body"><tr><td colspan="4" style="color:var(--text3)">Run a query above.</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Enrolled Participants</div>
      <div id="participants-list" style="color:var(--text2);font-size:.84rem;">Loading&hellip;</div>
    </div>
    <div class="card">
      <div class="card-title">&#x1F52C; AI Participant Evaluation</div>
      <div class="form-row">
        <div class="form-group"><label>Participant ID</label><select id="eval-participant"></select></div>
        <div class="form-group"><label>Metric</label><select id="eval-metric"></select></div>
        <div class="form-group"><label>Hours</label><input id="eval-hours" type="number" value="24" min="1" max="168"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-primary" onclick="evaluateParticipant()">&#x1F916; Evaluate</button></div>
      </div>
      <div id="eval-result" class="chat-box" style="display:none"></div>
    </div>
  </div>

</div>

<!-- ════════════════════════════════════════════
     RULES & ALERTS
     ════════════════════════════════════════════ -->
<div class="page" id="page-rules">
  <div class="page-title">&#x1F6E1;&#xFE0F; Rules &amp; Alerts</div>

  <div class="card">
    <div class="card-title">&#x2795; Add Monitoring Rule</div>
    <div class="form-row">
      <div class="form-group"><label>Metric</label><select id="rule-metric"></select></div>
      <div class="form-group"><label>Condition</label><input id="rule-condition" placeholder="e.g. value > 120"></div>
      <div class="form-group"><label>Severity</label>
        <select id="rule-severity"><option value="info">Info</option><option value="warning" selected>Warning</option><option value="critical">Critical</option></select>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:.65rem"><label>Message Template</label><input id="rule-message" value="Metric {metric_type} value {value} breached rule."></div>
    <button class="btn btn-primary" onclick="addRule()">Add Rule</button>
  </div>

  <div class="card">
    <div class="card-title">&#x1F4DD; Active Rules <span class="sub" id="rules-count"></span></div>
    <table>
      <thead><tr><th>ID</th><th>Metric</th><th>Condition</th><th>Severity</th><th>Message</th><th></th></tr></thead>
      <tbody id="rules-body"></tbody>
    </table>
  </div>

  <div class="card">
    <div class="card-title">&#x1F514; Alert History</div>
    <div class="form-row" style="margin-bottom:.5rem">
      <div class="form-group"><label>Participant</label><select id="al-participant"></select></div>
      <div class="form-group" style="justify-content:flex-end"><button class="btn btn-outline btn-sm" onclick="loadAlerts()">&#x1F50D; Load Alerts</button></div>
    </div>
    <table>
      <thead><tr><th>Time</th><th>Severity</th><th>Metric</th><th>Value</th><th>Message</th></tr></thead>
      <tbody id="alerts-body"><tr><td colspan="5" style="color:var(--text3)">Click Load to query alerts.</td></tr></tbody>
    </table>
  </div>
</div>

<!-- ════════════════════════════════════════════
     AGENT TOOLS — View & test tools directly
     ════════════════════════════════════════════ -->
<div class="page" id="page-tools">
  <div class="page-title">&#x1F9EA; Agent Tools <span class="sub">LangGraph ReAct tools the AI can invoke</span></div>
  <p style="color:var(--text2);font-size:.82rem;margin-bottom:.85rem;">
    These are the tools available to the AI agent. Click <strong>Test</strong> to invoke any tool directly with your own parameters and see the raw output.
  </p>

  <div class="stats-row">
    <div class="stat-card" style="border-left:3px solid var(--accent)">
      <div class="label">Agent Tools</div>
      <div class="number" id="tools-count">&mdash;</div>
      <div class="sub">LangChain tools</div>
    </div>
    <div class="stat-card" style="border-left:3px solid var(--info)">
      <div class="label">API Endpoints</div>
      <div class="number" id="api-count">&mdash;</div>
      <div class="sub">REST routes</div>
    </div>
    <div class="stat-card" style="border-left:3px solid var(--success)">
      <div class="label">Components</div>
      <div class="number" id="comp-count">&mdash;</div>
      <div class="sub">services</div>
    </div>
    <div class="stat-card" style="border-left:3px solid var(--warning)">
      <div class="label">Metrics</div>
      <div class="number" id="metric-count">&mdash;</div>
      <div class="sub">tracked</div>
    </div>
  </div>

  <!-- Agent Tools with Test buttons -->
  <div id="tools-list">
    <div style="color:var(--text3)">Loading agent tools&hellip;</div>
  </div>

  <!-- API Endpoints -->
  <div class="card" style="margin-top:.75rem">
    <div class="card-title">&#x1F310; API Endpoints</div>
    <div class="filter-bar" id="api-filter-bar"></div>
    <div style="overflow-x:auto">
      <table>
        <thead><tr><th>Method</th><th>Path</th><th>Name</th><th>Description</th></tr></thead>
        <tbody id="api-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Architecture Diagram -->
  <div class="card">
    <div class="card-title">&#x1F3D7;&#xFE0F; Architecture Flow</div>
    <div id="arch-diagram" style="padding:.4rem;overflow-x:auto"></div>
  </div>
</div>

<!-- ════════════════════════════════════════════
     AGENT CHAT
     ════════════════════════════════════════════ -->
<div class="page" id="page-chat">
  <div class="page-title">&#x1F916; Agent Chat</div>
  <div class="card">
    <p style="color:var(--text2);font-size:.82rem;margin-bottom:.65rem;">
      Ask the AI agent research questions. It can query participant data, compute statistics, detect anomalies, and reason about physiological patterns.
    </p>
    <div class="chat-box" id="chat-messages"><em style="color:var(--text3)">No messages yet. Ask a question below.</em></div>
    <div class="chat-input-row" style="margin-top:.65rem">
      <input id="chat-input" placeholder="e.g. Summarise P001's heart rate for the last 24h" onkeydown="if(event.key==='Enter')sendChat()">
      <button class="btn btn-primary" onclick="sendChat()">Send</button>
    </div>
  </div>
</div>

</div><!-- .main -->
</div><!-- .shell -->

<!-- ── Metric Edit Modal ───────────────────── -->
<div class="modal-overlay" id="metric-edit-modal">
  <div class="modal-box">
    <div class="modal-title">&#x270F;&#xFE0F; Edit Metric <button class="modal-close" onclick="closeMetricModal()">&times;</button></div>
    <input type="hidden" id="me-key">
    <div class="form-group" style="margin-bottom:.55rem"><label>Label</label><input id="me-label"></div>
    <div class="form-row">
      <div class="form-group"><label>Unit</label><input id="me-unit"></div>
      <div class="form-group"><label>Range Low</label><input id="me-range-low" type="number" step="0.1"></div>
      <div class="form-group"><label>Range High</label><input id="me-range-high" type="number" step="0.1"></div>
    </div>
    <div class="form-group" style="margin-top:.55rem"><label>Description</label><textarea id="me-description" rows="3"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeMetricModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveMetricEdit()">&#x1F4BE; Save</button>
    </div>
    <div id="me-result" style="font-size:.76rem;margin-top:.35rem"></div>
  </div>
</div>

<!-- ── Tool Test Modal ─────────────────────── -->
<div class="modal-overlay" id="tool-test-modal">
  <div class="modal-box" style="width:560px">
    <div class="modal-title">&#x1F9EA; Test Tool: <span id="tt-name" style="font-family:monospace;color:var(--accent-light)"></span> <button class="modal-close" onclick="closeToolTestModal()">&times;</button></div>
    <div id="tt-desc" style="font-size:.78rem;color:var(--text2);margin-bottom:.65rem;"></div>
    <div id="tt-params-form"></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeToolTestModal()">Cancel</button>
      <button class="btn btn-test" id="tt-run-btn" onclick="runToolTest()">&#x25B6; Run Tool</button>
    </div>
    <div id="tt-result" style="margin-top:.65rem;display:none">
      <div style="font-size:.72rem;color:var(--text2);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.05em">Result</div>
      <div class="test-result" id="tt-output"></div>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════
   RESEARCH CONTROL PANEL — JavaScript
   ═══════════════════════════════════════════════════ */

const API = '';

// ── State ─────────────────────────────────────
let ws = null;
let wsConnected = false;
let feedMessages = [];
let toolsData = null;
let apiTagFilter = 'all';
let sensorCatFilter = 'all';
const MAX_FEED = 200;

// ── Live data tracking (sent to app) ──────────
let liveReadings = [];       // recent readings sent to app
let liveAlerts = [];         // recent alerts sent to app
let liveAffect = [];         // recent affect inferences
const MAX_LIVE = 150;
let liveStats = { totalReadings: 0, totalAlerts: 0, totalAffect: 0, readingsPerSec: 0, metricCounts: {} };
let liveRateWindow = [];     // timestamps for rate calc
let activeDataTab = 'live';  // current data tab

// Metric categories for filtering
const METRIC_CATEGORIES = {
  heart_rate: 'cardiac', resting_heart_rate: 'cardiac', hrv: 'cardiac',
  breathing_rate: 'respiratory', spo2: 'respiratory',
  steps: 'activity', calories: 'activity', distance: 'activity', floors: 'activity',
  active_zone_minutes: 'activity', sedentary_minutes: 'activity',
  lightly_active_minutes: 'activity', moderately_active_minutes: 'activity', very_active_minutes: 'activity',
  sleep: 'sleep', sleep_efficiency: 'sleep',
  skin_temperature: 'body', skin_temperature_variation: 'body',
  body_weight: 'body', body_fat: 'body', vo2_max: 'body',
  stress: 'affect', affect_tag: 'affect'
};

const CAT_COLORS = {
  cardiac: 'var(--cardiac)', respiratory: 'var(--respiratory)', activity: 'var(--activity)',
  sleep: 'var(--sleep-c)', body: 'var(--body)', affect: 'var(--affect-c)'
};

// ── Navigation ────────────────────────────────
document.querySelectorAll('.nav-item').forEach(function(item) {
  item.addEventListener('click', function() {
    document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
    document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
    item.classList.add('active');
    document.getElementById('page-' + item.dataset.page).classList.add('active');
  });
});

function goTo(page) {
  document.querySelectorAll('.nav-item').forEach(function(n) {
    n.classList.remove('active');
    if (n.dataset.page === page) n.classList.add('active');
  });
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('page-' + page).classList.add('active');
}

// Sensor category filter
document.querySelectorAll('[data-sensor-cat]').forEach(function(chip) {
  chip.addEventListener('click', function() {
    document.querySelectorAll('[data-sensor-cat]').forEach(function(c) { c.classList.remove('active'); });
    chip.classList.add('active');
    sensorCatFilter = chip.dataset.sensorCat;
    renderSensorGrid();
  });
});

// ── Helpers ────────────────────────────────────
async function apiCall(method, path, body) {
  var opts = { method: method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  var r = await fetch(API + path, opts);
  if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
  return r.json();
}

function fmtTime(iso) { return new Date(iso).toLocaleTimeString(); }
function fmtDate(iso) { return new Date(iso).toLocaleString(); }
function nowTime() { return new Date().toLocaleTimeString(); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function sevBadge(s) {
  var c = s==='critical'?'badge-critical':s==='warning'?'badge-warning':'badge-info';
  return '<span class="badge '+c+'">'+s+'</span>';
}

// ── Populate metric <select> elements ─────────
function populateMetricSelects() {
  if (!toolsData) return;
  var selects = ['rd-metric','ing-metric','rule-metric','eval-metric'];
  selects.forEach(function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = toolsData.metrics.map(function(m) {
      return '<option value="'+esc(m.key)+'">'+esc(m.label)+' ('+esc(m.key)+')</option>';
    }).join('');
  });
}

// ── Populate participant <select> elements ────
function populateParticipantSelects() {
  var selects = ['ing-participant','rd-participant','eval-participant','al-participant','stream-participant','media-participant'];
  selects.forEach(function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    var opts = '<option value="">Select participant...</option>';
    if (participantsList.length) {
      opts += participantsList.map(function(p) {
        return '<option value="'+esc(p)+'">'+esc(p)+'</option>';
      }).join('');
    }
    el.innerHTML = opts;
    if (participantsList.length > 0) el.value = participantsList[0];
  });
}

// ── WebSocket ─────────────────────────────────
function connectWS() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws/stream?channel=all');

  ws.onopen = function() {
    wsConnected = true;
    document.getElementById('status-dot').className = 'dot online';
    document.getElementById('status-text').textContent = 'Online';
    addFeed('system', 'Admin panel connected');
  };

  ws.onmessage = function(event) {
    try { handleWSMessage(JSON.parse(event.data)); } catch(e) {}
  };

  ws.onclose = function() {
    wsConnected = false;
    document.getElementById('status-dot').className = 'dot';
    document.getElementById('status-text').textContent = 'Reconnecting\u2026';
    setTimeout(connectWS, 3000);
  };

  ws.onerror = function() {
    document.getElementById('status-text').textContent = 'Error';
  };
}

function handleWSMessage(msg) {
  var type = msg.type || 'unknown';
  var d = msg.data || {};
  var now = Date.now();
  if (type === 'reading') {
    addFeed(d.metric_type || 'reading', (d.participant_id||'?')+' '+(d.metric_type||'?')+' = '+(d.value!=null?d.value:'?')+' '+(d.unit||''));
    // Track live data sent to app
    liveReadings.unshift({ ts: nowTime(), participant: d.participant_id||'?', metric: d.metric_type||'?', value: d.value!=null?d.value:'?', unit: d.unit||'', type: 'reading' });
    if (liveReadings.length > MAX_LIVE) liveReadings.length = MAX_LIVE;
    liveStats.totalReadings++;
    liveStats.metricCounts[d.metric_type||'unknown'] = (liveStats.metricCounts[d.metric_type||'unknown']||0) + 1;
    liveRateWindow.push(now);
    updateLiveData();
  } else if (type === 'alert') {
    addFeed('alert', '\u26A0 '+(d.participant_id||'?')+' '+(d.severity||'')+' \u2014 '+(d.message||''));
    liveAlerts.unshift({ ts: nowTime(), participant: d.participant_id||'?', metric: d.metric||'alert', value: d.severity||'?', unit: '', type: 'alert' });
    if (liveAlerts.length > MAX_LIVE) liveAlerts.length = MAX_LIVE;
    liveStats.totalAlerts++;
    updateLiveData();
  } else if (type === 'affect') {
    addFeed('affect', '\uD83E\uDDE0 '+(d.participant_id||'?')+' affect inference');
    liveAffect.unshift({ ts: nowTime(), participant: d.participant_id||'?', metric: 'affect', value: d.tag||'inference', unit: '', type: 'affect' });
    if (liveAffect.length > MAX_LIVE) liveAffect.length = MAX_LIVE;
    liveStats.totalAffect++;
    updateLiveData();
  } else if (type === 'system') {
    addFeed('system', (msg.event||'system')+': '+JSON.stringify(d).slice(0,80));
  }
}

function addFeed(type, summary) {
  feedMessages.unshift({ ts: nowTime(), type: type, summary: summary });
  if (feedMessages.length > MAX_FEED) feedMessages.length = MAX_FEED;
  renderFeed();
}

function renderFeed() {
  var el = document.getElementById('live-feed');
  document.getElementById('feed-count').textContent = feedMessages.length + ' events';
  var tagColors = {
    heart_rate:'#e17055', steps:'#00b894', sleep:'#6c5ce7', spo2:'#74b9ff', hrv:'#fdcb6e',
    calories:'#fd79a8', alert:'#fdcb6e', affect:'#a29bfe', system:'#8b8fa3', reading:'#00cec9'
  };
  el.innerHTML = feedMessages.slice(0,100).map(function(m) {
    var c = tagColors[m.type] || 'var(--text2)';
    return '<div class="feed-entry"><span class="ts">'+m.ts+'</span><span class="tag" style="color:'+c+'">'+m.type+'</span><span class="msg">'+esc(m.summary)+'</span></div>';
  }).join('') || '<div class="feed-entry"><span class="ts">--</span><span class="msg" style="color:var(--text3)">No events yet.</span></div>';
}

// ── Tab switching ─────────────────────────────
function switchDataTab(tab) {
  activeDataTab = tab;
  document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('tab-' + tab).classList.add('active');
  // Highlight the clicked tab button
  var tabLabels = { live: 'live data', ingest: 'ingest', query: 'query', feed: 'feed', media: 'media' };
  document.querySelectorAll('.tab-btn').forEach(function(b) {
    if (b.textContent.toLowerCase().indexOf(tabLabels[tab] || tab) !== -1) {
      b.classList.add('active');
    }
  });
  if (tab === 'live') { renderLiveTable(); pollServerStreamStats(); }
  if (tab === 'media') { loadMediaLibrary(); }
}

// ── Media Upload & Library ────────────────────
async function uploadMedia() {
  var pid = document.getElementById('media-participant').value;
  var label = document.getElementById('media-label').value.trim();
  var notes = document.getElementById('media-notes').value.trim();
  var fileInput = document.getElementById('media-file');
  var resultEl = document.getElementById('media-upload-result');
  if (!pid) { resultEl.innerHTML = '<span style="color:var(--warning)">\u26A0 Select a participant.</span>'; return; }
  if (!fileInput.files.length) { resultEl.innerHTML = '<span style="color:var(--warning)">\u26A0 Choose a file.</span>'; return; }
  var btn = document.getElementById('media-upload-btn');
  btn.disabled = true; btn.textContent = '\u23F3 Uploading\u2026';
  resultEl.innerHTML = '';
  var form = new FormData();
  form.append('file', fileInput.files[0]);
  form.append('participant_id', pid);
  form.append('label', label);
  form.append('notes', notes);
  try {
    var r = await fetch(API + '/media/upload', { method: 'POST', body: form });
    if (!r.ok) throw new Error(r.status + ' ' + (await r.text()));
    var data = await r.json();
    resultEl.innerHTML = '<span style="color:var(--success)">\u2713 Uploaded <strong>' + esc(data.filename) + '</strong> (' + data.media_type + ', ' + data.size_kb + ' KB)</span>';
    fileInput.value = '';
    addFeed('system', 'Media uploaded: ' + data.media_type + ' for ' + pid);
    loadMediaLibrary();
  } catch(e) {
    resultEl.innerHTML = '<span style="color:var(--danger)">\u2715 ' + esc(e.message) + '</span>';
  }
  btn.disabled = false; btn.textContent = '\uD83D\uDCE4 Upload';
}

async function loadMediaLibrary() {
  try {
    var data = await apiCall('GET', '/media');
    document.getElementById('media-count').textContent = data.length + ' files';
    var typeIcons = { audio: '\uD83C\uDFA7', video: '\uD83C\uDFA5' };
    var typeColors = { audio: '#a29bfe', video: '#fd79a8' };
    document.getElementById('media-body').innerHTML = data.length
      ? data.map(function(m) {
          var ic = typeIcons[m.media_type] || '\uD83D\uDCC1';
          var tc = typeColors[m.media_type] || 'var(--text2)';
          return '<tr><td><span style="color:'+tc+';font-weight:600">'+ic+' '+m.media_type+'</span></td>'+
            '<td>'+esc(m.participant_id)+'</td>'+
            '<td>'+esc(m.label)+'</td>'+
            '<td style="font-size:.78rem;color:var(--text2)">'+esc(m.filename)+'</td>'+
            '<td>'+m.size_kb+' KB</td>'+
            '<td style="font-size:.76rem">'+fmtDate(m.uploaded_at)+'</td>'+
            '<td><button class="btn btn-danger btn-sm" onclick="deleteMedia(\''+m.id+'\')">\u2715</button></td></tr>';
        }).join('')
      : '<tr><td colspan="7" style="color:var(--text3)">No media uploaded yet.</td></tr>';
  } catch(e) {
    document.getElementById('media-body').innerHTML = '<tr><td colspan="7" style="color:var(--danger)">'+esc(e.message)+'</td></tr>';
  }
}

async function deleteMedia(id) {
  try {
    await apiCall('DELETE', '/media/' + id);
    addFeed('system', 'Media deleted: ' + id);
    loadMediaLibrary();
  } catch(e) { alert('Delete failed: ' + e.message); }
}

// ── Live data dashboard ───────────────────────
function updateLiveData() {
  // Calc readings/sec from last 10 seconds
  var now = Date.now();
  liveRateWindow = liveRateWindow.filter(function(t) { return now - t < 10000; });
  liveStats.readingsPerSec = (liveRateWindow.length / 10).toFixed(1);

  // Update stat counters
  var el;
  el = document.getElementById('ds-readings'); if (el) el.textContent = liveStats.totalReadings.toLocaleString();
  el = document.getElementById('ds-alerts'); if (el) el.textContent = liveStats.totalAlerts.toLocaleString();
  el = document.getElementById('ds-affect'); if (el) el.textContent = liveStats.totalAffect.toLocaleString();
  el = document.getElementById('ds-rate'); if (el) el.textContent = liveStats.readingsPerSec;

  // Metric breakdown badges
  renderMetricBreakdown();

  // Live table (only update if live tab is visible for performance)
  if (activeDataTab === 'live') renderLiveTable();
}

function renderMetricBreakdown() {
  var el = document.getElementById('metric-breakdown');
  if (!el) return;
  var counts = liveStats.metricCounts;
  var keys = Object.keys(counts).sort(function(a,b) { return counts[b] - counts[a]; });
  var countEl = document.getElementById('metric-breakdown-count');
  if (countEl) countEl.textContent = keys.length + ' metrics';
  if (keys.length === 0) {
    el.innerHTML = '<span style="color:var(--text3)">No data yet. Start a stream to see metric counts.</span>';
    return;
  }
  el.innerHTML = keys.map(function(k) {
    var cat = METRIC_CATEGORIES[k] || 'body';
    var color = CAT_COLORS[cat] || 'var(--text2)';
    return '<span class="badge" style="background:'+color+'22;color:'+color+';border:1px solid '+color+'44;padding:.25rem .55rem">'+esc(k)+' <strong>'+counts[k].toLocaleString()+'</strong></span>';
  }).join('');
}

function renderLiveTable() {
  var body = document.getElementById('live-data-body');
  if (!body) return;
  // Merge all live entries and sort by most recent
  var all = liveReadings.concat(liveAlerts, liveAffect).slice(0, 100);
  var countEl = document.getElementById('live-table-count');
  if (countEl) countEl.textContent = all.length + ' entries';
  if (all.length === 0) {
    body.innerHTML = '<tr><td colspan="6" style="color:var(--text3)">Waiting for data stream&hellip;</td></tr>';
    return;
  }
  var typeColors = { reading: '#00cec9', alert: '#fdcb6e', affect: '#a29bfe' };
  body.innerHTML = all.map(function(r) {
    var tc = typeColors[r.type] || 'var(--text2)';
    return '<tr><td>'+r.ts+'</td><td>'+esc(r.participant)+'</td><td>'+esc(r.metric)+'</td><td>'+esc(String(r.value))+'</td><td>'+esc(r.unit)+'</td><td><span style="color:'+tc+';font-weight:600;font-size:.72rem;text-transform:uppercase">'+r.type+'</span></td></tr>';
  }).join('');
}

// ── Server-side stream stats polling ──────────
async function pollServerStreamStats() {
  try {
    var data = await apiCall('GET', '/admin/api/stream-stats');
    var el;
    el = document.getElementById('ds-clients');
    if (el) el.textContent = (data.connections && data.connections.total != null) ? data.connections.total : '-';
    el = document.getElementById('ds-server-rate');
    if (el && data.throughput) el.textContent = (data.throughput.outbound_rate_per_sec || 0).toFixed(1);
  } catch(e) {}
}
// Poll server stats every 5s when on live tab
setInterval(function() { if (activeDataTab === 'live') pollServerStreamStats(); }, 5000);

// ── Overview ──────────────────────────────────
async function refreshOverview() {
  try {
    var stats = await apiCall('GET', '/api/stats');
    document.getElementById('ov-readings').textContent = stats.total_readings.toLocaleString();
    document.getElementById('ov-alerts').textContent = stats.total_alerts.toLocaleString();
    document.getElementById('ov-participants').textContent = (stats.participants||[]).length;
    document.getElementById('ov-alert-count').textContent = stats.recent_alerts.length + ' recent';

    if (stats.participants && stats.participants.length) {
      participantsList = stats.participants;
      populateParticipantSelects();
      document.getElementById('participants-list').innerHTML = stats.participants.map(function(p) {
        return '<span class="badge badge-info" style="margin:.15rem;cursor:pointer" onclick="var el=document.getElementById(\'eval-participant\');if(el)el.value=\''+p+'\';">'+p+'</span>';
      }).join('');
    } else {
      document.getElementById('participants-list').textContent = 'No participants found yet.';
    }

    var alertsHtml = stats.recent_alerts.map(function(a) {
      return '<tr><td>'+fmtDate(a.timestamp)+'</td><td>'+a.participant_id+'</td><td>'+a.metric+'</td><td>'+a.value+'</td><td>'+sevBadge(a.severity)+'</td><td style="max-width:240px;overflow:hidden;text-overflow:ellipsis">'+a.message+'</td></tr>';
    }).join('');
    document.getElementById('ov-alerts-body').innerHTML = alertsHtml || '<tr><td colspan="6" style="color:var(--text3)">No recent alerts.</td></tr>';
  } catch(e) {}

  try {
    var rules = await apiCall('GET', '/rules');
    document.getElementById('ov-rules').textContent = rules.length;
  } catch(e) {}

  try {
    var health = await apiCall('GET', '/health');
    if (!wsConnected) document.getElementById('status-text').textContent = 'Online (polling)';
  } catch(e) {
    document.getElementById('status-text').textContent = 'Offline';
    document.getElementById('status-dot').className = 'dot';
  }
}

async function refreshComponents() {
  try {
    var info = await apiCall('GET', '/system/info');
    var items = [
      { name: 'Pipeline', ok: info.pipeline && info.pipeline.running, detail: (info.pipeline&&info.pipeline.pending||0)+' pending' },
      { name: 'Agent', ok: info.agent && info.agent.ready, detail: '' },
      { name: 'Rule Engine', ok: info.rule_engine && info.rule_engine.ready, detail: (info.rule_engine&&info.rule_engine.rule_count||0)+' rules' },
      { name: 'Affect', ok: info.affect_pipeline && info.affect_pipeline.ready, detail: '' },
      { name: 'Scheduler', ok: info.scheduler && info.scheduler.running, detail: (info.scheduler&&info.scheduler.interval_minutes||'?')+'m' },
      { name: 'WebSocket', ok: true, detail: (info.websocket&&info.websocket.connected_clients||0)+' clients' },
    ];
    document.getElementById('ov-components').innerHTML = items.map(function(c) {
      var color = c.ok ? 'var(--success)' : 'var(--text3)';
      return '<div class="comp-chip"><span class="comp-dot" style="background:'+color+'"></span><span class="comp-name">'+c.name+'</span><span class="comp-detail">'+c.detail+'</span></div>';
    }).join('');
  } catch(e) {}
}

// ── Sensors & Metrics ─────────────────────────
function renderSensorGrid() {
  if (!toolsData) return;
  var metrics = toolsData.metrics;
  if (sensorCatFilter !== 'all') {
    metrics = metrics.filter(function(m) { return METRIC_CATEGORIES[m.key] === sensorCatFilter; });
  }
  document.getElementById('sensor-count').textContent = metrics.length + ' of ' + toolsData.metrics.length + ' metrics';

  document.getElementById('sensor-grid').innerHTML = metrics.map(function(m) {
    var cat = METRIC_CATEGORIES[m.key] || 'body';
    var color = CAT_COLORS[cat] || 'var(--text3)';
    var rangeStr = m.normal_range ? m.normal_range[0]+' \u2013 '+m.normal_range[1]+' '+(m.unit||'') : 'N/A';
    return '<div class="metric-card" style="border-left-color:'+color+'">'+
      '<div class="mc-header">'+
        '<span class="mc-label" style="color:'+color+'">'+esc(m.label)+'</span>'+
        '<span class="mc-key">'+esc(m.key)+'</span>'+
      '</div>'+
      '<div class="mc-desc">'+esc(m.description||'No description.')+'</div>'+
      '<div class="mc-meta">'+
        '<span><span style="color:var(--text3)">Unit:</span> <span style="color:var(--text)">'+esc(m.unit||'\u2013')+'</span></span>'+
        '<span><span style="color:var(--text3)">Normal:</span> <span style="color:var(--success)">'+rangeStr+'</span></span>'+
        '<span><span style="color:var(--text3)">Category:</span> <span style="color:'+color+'">'+cat+'</span></span>'+
      '</div>'+
      '<div class="mc-actions">'+
        '<button class="mc-edit-btn" onclick="openMetricModal(\''+esc(m.key)+'\')">&#x270F;&#xFE0F; Edit</button>'+
      '</div>'+
    '</div>';
  }).join('') || '<div style="color:var(--text3)">No metrics match this filter.</div>';
}

// ── Tool Inventory & Testing ──────────────────
async function loadToolsInventory() {
  try {
    toolsData = await apiCall('GET', '/admin/api/tools');
    document.getElementById('ov-tools').textContent = toolsData.agent_tools.length;
    document.getElementById('tools-count').textContent = toolsData.agent_tools.length;
    document.getElementById('api-count').textContent = toolsData.api_routes.length;
    document.getElementById('comp-count').textContent = toolsData.components.length;
    document.getElementById('metric-count').textContent = toolsData.metrics.length;

    populateMetricSelects();
    renderSensorGrid();
    renderAgentTools();
    renderApiTable();
    renderArchDiagram();
  } catch(e) {
    document.getElementById('tools-list').innerHTML = '<span style="color:var(--danger)">Failed: '+e.message+'</span>';
  }
}

function renderAgentTools() {
  if (!toolsData) return;
  var html = toolsData.agent_tools.map(function(t) {
    var params = Object.keys(t.parameters||{}).map(function(p) {
      var info = t.parameters[p];
      return '<span class="tc-param"><span class="pname">'+esc(p)+'</span><span class="ptype">'+esc(info.type)+'</span>'+(info.required?'<span class="preq">*</span>':'')+'</span>';
    }).join('');

    return '<div class="tool-card">'+
      '<div class="tc-header">'+
        '<span style="font-size:1rem">&#x1F527;</span>'+
        '<span class="tc-name">'+esc(t.name)+'</span>'+
        '<button class="btn btn-test btn-sm" style="margin-left:auto" onclick="openToolTestModal(\''+esc(t.name)+'\')">&#x25B6; Test</button>'+
      '</div>'+
      '<div class="tc-desc">'+esc(t.description)+'</div>'+
      (params ? '<div class="tc-params">'+params+'</div>' : '')+
    '</div>';
  }).join('');
  document.getElementById('tools-list').innerHTML = html || '<span style="color:var(--text3)">No tools registered.</span>';
}

function renderApiTable() {
  if (!toolsData) return;
  var tagSet = {};
  toolsData.api_routes.forEach(function(r) { (r.tags||[]).forEach(function(t) { tagSet[t]=true; }); });
  var tags = ['all'].concat(Object.keys(tagSet).sort());
  document.getElementById('api-filter-bar').innerHTML = tags.map(function(t) {
    return '<span class="filter-chip'+(t===apiTagFilter?' active':'')+'" data-api-tag="'+t+'">'+t+'</span>';
  }).join('');
  document.querySelectorAll('[data-api-tag]').forEach(function(chip) {
    chip.addEventListener('click', function() {
      document.querySelectorAll('[data-api-tag]').forEach(function(c) { c.classList.remove('active'); });
      chip.classList.add('active');
      apiTagFilter = chip.dataset.apiTag;
      renderApiRows();
    });
  });
  renderApiRows();
}

function renderApiRows() {
  if (!toolsData) return;
  var filtered = apiTagFilter==='all' ? toolsData.api_routes : toolsData.api_routes.filter(function(r) { return (r.tags||[]).indexOf(apiTagFilter)!==-1; });
  var mc = { GET:'var(--success)', POST:'var(--accent-light)', DELETE:'var(--danger)', PUT:'var(--warning)', PATCH:'var(--warning)' };
  document.getElementById('api-body').innerHTML = filtered.map(function(r) {
    var methods = (r.methods||[]).map(function(m) {
      var c = mc[m]||'var(--text2)'; return '<span style="display:inline-block;padding:.08rem .35rem;border-radius:4px;font-size:.66rem;font-weight:700;font-family:monospace;background:'+c+'22;color:'+c+';margin-right:.15rem">'+m+'</span>';
    }).join('');
    var desc = (r.summary||'').split('\n')[0].trim();
    if (desc.length>90) desc = desc.slice(0,90)+'\u2026';
    return '<tr><td>'+methods+'</td><td style="font-family:monospace;font-size:.78rem;color:var(--info)">'+esc(r.path)+'</td><td style="font-size:.78rem">'+esc(r.name||'')+'</td><td style="font-size:.76rem;color:var(--text2);max-width:280px;overflow:hidden;text-overflow:ellipsis">'+esc(desc)+'</td></tr>';
  }).join('') || '<tr><td colspan="4" style="color:var(--text3)">No routes match.</td></tr>';
}

// ── Tool Test Modal ───────────────────────────
var currentTestTool = null;

function openToolTestModal(toolName) {
  if (!toolsData) return;
  var t = toolsData.agent_tools.find(function(x) { return x.name === toolName; });
  if (!t) return;
  currentTestTool = t;
  document.getElementById('tt-name').textContent = t.name;
  document.getElementById('tt-desc').textContent = t.description;
  document.getElementById('tt-result').style.display = 'none';
  document.getElementById('tt-output').style.color = '';

  var paramKeys = Object.keys(t.parameters || {});
  if (paramKeys.length) {
    var formHtml = paramKeys.map(function(p) {
      var info = t.parameters[p];
      return '<div class="form-group" style="margin-bottom:.5rem">'+
        '<label>'+esc(p)+' <span style="color:var(--text3);font-size:.68rem">('+esc(info.type)+')</span>'+(info.required?' <span style="color:var(--danger)">*</span>':'')+'</label>'+
        '<input id="tt-p-'+esc(p)+'" placeholder="'+(info.default && info.default!=='None' ? esc(info.default) : '')+'" data-param-name="'+esc(p)+'">'+
      '</div>';
    }).join('');
    document.getElementById('tt-params-form').innerHTML = formHtml;
  } else {
    document.getElementById('tt-params-form').innerHTML = '<div style="font-size:.8rem;color:var(--text3)">This tool takes no parameters.</div>';
  }

  document.getElementById('tool-test-modal').classList.add('open');
}

function closeToolTestModal() {
  document.getElementById('tool-test-modal').classList.remove('open');
  currentTestTool = null;
}

async function runToolTest() {
  if (!currentTestTool) return;
  var params = {};
  document.querySelectorAll('#tt-params-form input[data-param-name]').forEach(function(inp) {
    var v = inp.value.trim();
    if (v !== '') {
      if (!isNaN(v) && v !== '') params[inp.dataset.paramName] = parseFloat(v);
      else {
        try { params[inp.dataset.paramName] = JSON.parse(v); } catch(e) { params[inp.dataset.paramName] = v; }
      }
    }
  });

  var btn = document.getElementById('tt-run-btn');
  btn.disabled = true;
  btn.textContent = '\u23F3 Running\u2026';
  document.getElementById('tt-result').style.display = 'block';
  document.getElementById('tt-output').style.color = '';
  document.getElementById('tt-output').textContent = 'Executing ' + currentTestTool.name + '(\u2026)\nPlease wait\u2026';

  try {
    var res = await apiCall('POST', '/admin/api/tools/test', { tool_name: currentTestTool.name, parameters: params });
    var output = typeof res.result === 'string' ? res.result : JSON.stringify(res.result, null, 2);
    document.getElementById('tt-output').textContent = output;
  } catch(e) {
    document.getElementById('tt-output').textContent = '\u2717 Error: ' + e.message;
    document.getElementById('tt-output').style.color = 'var(--danger)';
  }
  btn.disabled = false;
  btn.textContent = '\u25B6 Run Tool';
}

// ── Metric Edit Modal ─────────────────────────
function openMetricModal(key) {
  if (!toolsData) return;
  var m = toolsData.metrics.find(function(x) { return x.key === key; });
  if (!m) return;
  document.getElementById('me-key').value = key;
  document.getElementById('me-label').value = m.label || '';
  document.getElementById('me-unit').value = m.unit || '';
  document.getElementById('me-range-low').value = m.normal_range ? m.normal_range[0] : '';
  document.getElementById('me-range-high').value = m.normal_range ? m.normal_range[1] : '';
  document.getElementById('me-description').value = m.description || '';
  document.getElementById('me-result').innerHTML = '';
  document.getElementById('metric-edit-modal').classList.add('open');
}

function closeMetricModal() { document.getElementById('metric-edit-modal').classList.remove('open'); }

async function saveMetricEdit() {
  var key = document.getElementById('me-key').value;
  var body = { label: document.getElementById('me-label').value, unit: document.getElementById('me-unit').value, description: document.getElementById('me-description').value };
  var lo = document.getElementById('me-range-low').value;
  var hi = document.getElementById('me-range-high').value;
  body.normal_range = (lo !== '' && hi !== '') ? [parseFloat(lo), parseFloat(hi)] : null;
  try {
    await apiCall('PUT', '/admin/api/tools/metrics/' + key, body);
    document.getElementById('me-result').innerHTML = '<span style="color:var(--success)">\u2713 Saved</span>';
    await loadToolsInventory();
    setTimeout(closeMetricModal, 500);
  } catch(e) {
    document.getElementById('me-result').innerHTML = '<span style="color:var(--danger)">\u2717 ' + e.message + '</span>';
  }
}

// ── Readings ──────────────────────────────────
async function loadReadings() {
  var pid = document.getElementById('rd-participant').value;
  var metric = document.getElementById('rd-metric').value;
  var limit = document.getElementById('rd-limit').value;
  try {
    var data = await apiCall('GET', '/readings/'+pid+'?metric='+metric+'&limit='+limit);
    if (!data.length) { document.getElementById('readings-body').innerHTML = '<tr><td colspan="4" style="color:var(--text3)">No readings found.</td></tr>'; document.getElementById('readings-stats').textContent = ''; return; }
    var vals = data.map(function(r) { return r.value; });
    var sum = vals.reduce(function(a,b) { return a+b; },0);
    document.getElementById('readings-stats').textContent = data.length+' rows \u2014 Mean: '+(sum/vals.length).toFixed(1)+' | Min: '+Math.min.apply(null,vals).toFixed(1)+' | Max: '+Math.max.apply(null,vals).toFixed(1);
    document.getElementById('readings-body').innerHTML = data.map(function(r) { return '<tr><td>'+fmtDate(r.timestamp)+'</td><td><strong>'+r.value+'</strong></td><td>'+r.unit+'</td><td>'+r.device_type+'</td></tr>'; }).join('');
  } catch(e) { document.getElementById('readings-body').innerHTML = '<tr><td colspan="4" style="color:var(--danger)">'+e.message+'</td></tr>'; }
}

// ── Alerts ────────────────────────────────────
async function loadAlerts() {
  var pid = document.getElementById('al-participant').value;
  try {
    var data = await apiCall('GET', '/alerts/'+pid);
    document.getElementById('alerts-body').innerHTML = data.length
      ? data.map(function(a) { return '<tr><td>'+fmtDate(a.timestamp)+'</td><td>'+sevBadge(a.severity)+'</td><td>'+a.metric+'</td><td>'+a.value+'</td><td>'+a.message+'</td></tr>'; }).join('')
      : '<tr><td colspan="5" style="color:var(--text3)">No alerts.</td></tr>';
  } catch(e) { document.getElementById('alerts-body').innerHTML = '<tr><td colspan="5" style="color:var(--danger)">'+e.message+'</td></tr>'; }
}

// ── Rules ─────────────────────────────────────
async function loadRules() {
  try {
    var data = await apiCall('GET', '/rules');
    document.getElementById('rules-count').textContent = data.length + ' rules';
    document.getElementById('rules-body').innerHTML = data.map(function(r) {
      return '<tr><td style="font-family:monospace;font-size:.7rem">'+r.rule_id.slice(0,8)+'\u2026</td><td>'+r.metric_type+'</td>'+
        '<td><code style="background:var(--surface2);padding:.08rem .35rem;border-radius:4px">'+r.condition+'</code></td>'+
        '<td>'+sevBadge(r.severity)+'</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">'+r.message_template+'</td>'+
        '<td><button class="btn btn-danger btn-sm" onclick="deleteRule(\''+r.rule_id+'\')">\u2715</button></td></tr>';
    }).join('') || '<tr><td colspan="6" style="color:var(--text3)">No rules defined.</td></tr>';
  } catch(e) {}
}
async function addRule() {
  await apiCall('POST', '/rules', {
    metric_type: document.getElementById('rule-metric').value,
    condition: document.getElementById('rule-condition').value,
    severity: document.getElementById('rule-severity').value,
    message_template: document.getElementById('rule-message').value
  });
  document.getElementById('rule-condition').value = '';
  loadRules();
}
async function deleteRule(id) { await apiCall('DELETE', '/rules/'+id); loadRules(); }

// ── Ingest ────────────────────────────────────
async function ingestData() {
  try {
    var res = await apiCall('POST', '/ingest', {
      participant_id: document.getElementById('ing-participant').value,
      device_type: document.getElementById('ing-device').value,
      metric_type: document.getElementById('ing-metric').value,
      value: parseFloat(document.getElementById('ing-value').value),
      unit: document.getElementById('ing-unit').value
    });
    document.getElementById('ingest-result').innerHTML = '<span style="color:var(--success)">\u2713 Queued \u2014 ID: '+res.id+'</span>';
  } catch(e) { document.getElementById('ingest-result').innerHTML = '<span style="color:var(--danger)">\u2715 '+e.message+'</span>'; }
}

async function ingestBatch() {
  try {
    var raw = JSON.parse(document.getElementById('ing-batch').value);
    var res = await apiCall('POST', '/ingest/batch', raw);
    document.getElementById('batch-result').innerHTML = '<span style="color:var(--success)">\u2713 ' + res.count + ' readings queued</span>';
  } catch(e) { document.getElementById('batch-result').innerHTML = '<span style="color:var(--danger)">\u2715 '+e.message+'</span>'; }
}

// ── Participant Eval ──────────────────────────
async function evaluateParticipant() {
  var box = document.getElementById('eval-result');
  box.style.display = 'block';
  box.textContent = 'Evaluating\u2026 (may take a moment)';
  try {
    var res = await apiCall('GET', '/evaluate/'+document.getElementById('eval-participant').value+'?metric='+document.getElementById('eval-metric').value+'&hours='+document.getElementById('eval-hours').value);
    box.textContent = res.evaluation;
  } catch(e) { box.textContent = '\u26A0 Error: '+e.message; }
}

// ── Agent Chat ────────────────────────────────
var chatHist = [];
async function sendChat() {
  var input = document.getElementById('chat-input');
  var q = input.value.trim();
  if (!q) return;
  input.value = '';
  chatHist.push({ role:'user', text:q });
  renderChat();
  var box = document.getElementById('chat-messages');
  box.innerHTML += '\n<em style="color:var(--text3)">Thinking\u2026</em>';
  box.scrollTop = box.scrollHeight;
  try {
    var res = await apiCall('POST', '/analyse', { query: q });
    chatHist.push({ role:'agent', text:res.response });
  } catch(e) { chatHist.push({ role:'agent', text:'\u26A0 Error: '+e.message }); }
  renderChat();
}
function renderChat() {
  var box = document.getElementById('chat-messages');
  box.innerHTML = chatHist.map(function(m) {
    return m.role==='user'
      ? '<div style="color:var(--accent-light);margin:.35rem 0"><strong>You:</strong> '+esc(m.text)+'</div>'
      : '<div style="margin:.35rem 0"><strong>\uD83E\uDD16 Agent:</strong>\n'+esc(m.text)+'</div>';
  }).join('') || '<em style="color:var(--text3)">No messages yet.</em>';
  box.scrollTop = box.scrollHeight;
}

// ── Data Stream Controls ──────────────────────
function onStreamSourceChange() {
  document.getElementById('stream-speed-group').style.display = document.getElementById('stream-source').value === 'dataset' ? '' : 'none';
  document.getElementById('stream-participants-hint').style.display = 'none';
  document.getElementById('stream-result').innerHTML = '';
}

async function loadLifeSnapsParticipants() {
  try {
    var data = await apiCall('GET', '/lifesnaps/participants');
    var sel = document.getElementById('stream-participant');
    var hint = document.getElementById('stream-participants-hint');
    var list = document.getElementById('stream-participants-list');
    if (data.length) {
      sel.innerHTML = data.map(function(p) {
        return '<option value="'+esc(p)+'">'+esc(p)+'</option>';
      }).join('');
      hint.style.display = 'block';
      list.textContent = data.length + ' participants loaded';
    } else {
      sel.innerHTML = '<option value="">No participants found</option>';
      hint.style.display = 'block';
      list.textContent = 'No participants found.';
    }
  } catch(e) { document.getElementById('stream-result').innerHTML = '<span style="color:var(--danger)">\u2715 '+e.message+'</span>'; }
}

async function startDataStream() {
  var source = document.getElementById('stream-source').value;
  var pid = document.getElementById('stream-participant').value.trim();
  if (!pid) { document.getElementById('stream-result').innerHTML = '<span style="color:var(--warning)">\u26A0 Enter a participant ID.</span>'; return; }
  var btn = document.getElementById('stream-start-btn');
  btn.disabled = true; btn.textContent = '\u23F3 Starting\u2026';
  document.getElementById('stream-result').innerHTML = '';
  document.getElementById('stream-status-label').textContent = 'Starting\u2026';
  try {
    if (source === 'dataset') {
      var speed = parseFloat(document.getElementById('stream-speed').value);
      await apiCall('POST', '/lifesnaps/stream/'+pid, { speed: speed });
      document.getElementById('stream-status-label').textContent = '\uD83D\uDFE2 Streaming ('+speed+'x)';
      document.getElementById('stream-result').innerHTML = '<span style="color:var(--success)">\u2713 LifeSnaps stream started for <strong>'+pid+'</strong> at '+speed+'x</span>';
    } else {
      await apiCall('POST', '/sync/stream/'+pid, {});
      document.getElementById('stream-status-label').textContent = '\uD83D\uDFE2 Live Fitbit';
      document.getElementById('stream-result').innerHTML = '<span style="color:var(--success)">\u2713 Live Fitbit stream started for <strong>'+pid+'</strong></span>';
    }
    addFeed('system', 'Stream started: '+source+' \u2014 '+pid);
  } catch(e) {
    document.getElementById('stream-status-label').textContent = '\uD83D\uDD34 Error';
    document.getElementById('stream-result').innerHTML = '<span style="color:var(--danger)">\u2715 '+esc(e.message)+'</span>';
  }
  btn.disabled = false; btn.textContent = '\u25B6 Start Stream';
}

// ── Architecture Diagram ──────────────────────
function renderArchDiagram() {
  document.getElementById('arch-diagram').innerHTML = '<svg viewBox="0 0 900 420" style="width:100%;max-width:900px;height:auto;font-family:Segoe UI,system-ui,sans-serif">'+
    '<rect width="900" height="420" rx="12" fill="#1a1d27"/>'+
    '<text x="80" y="30" fill="#8b8fa3" font-size="11" text-anchor="middle" font-weight="600" letter-spacing=".08em">DATA SOURCES</text>'+
    '<rect x="20" y="42" width="120" height="44" rx="8" fill="#242736" stroke="#00cec9" stroke-width="1.5"/><text x="80" y="69" fill="#00cec9" font-size="12" text-anchor="middle" font-weight="600">Fitbit API</text>'+
    '<rect x="20" y="96" width="120" height="44" rx="8" fill="#242736" stroke="#00b894" stroke-width="1.5"/><text x="80" y="123" fill="#00b894" font-size="12" text-anchor="middle" font-weight="600">LifeSnaps CSV</text>'+
    '<rect x="20" y="150" width="120" height="44" rx="8" fill="#242736" stroke="#74b9ff" stroke-width="1.5"/><text x="80" y="177" fill="#74b9ff" font-size="12" text-anchor="middle" font-weight="600">Manual Ingest</text>'+
    '<line x1="140" y1="64" x2="200" y2="130" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/><line x1="140" y1="118" x2="200" y2="130" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/><line x1="140" y1="172" x2="200" y2="140" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/>'+
    '<rect x="200" y="100" width="140" height="64" rx="10" fill="#242736" stroke="#6c5ce7" stroke-width="2"/><text x="270" y="128" fill="#a29bfe" font-size="13" text-anchor="middle" font-weight="700">StreamPipeline</text><text x="270" y="148" fill="#5a5e73" font-size="10" text-anchor="middle">asyncio.Queue</text>'+
    '<line x1="340" y1="132" x2="390" y2="80" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/><line x1="340" y1="132" x2="390" y2="200" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/><line x1="340" y1="132" x2="390" y2="310" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/>'+
    '<text x="480" y="30" fill="#8b8fa3" font-size="11" text-anchor="middle" font-weight="600" letter-spacing=".08em">PROCESSING</text>'+
    '<rect x="390" y="42" width="160" height="56" rx="8" fill="#242736" stroke="#fdcb6e" stroke-width="1.5"/><text x="470" y="66" fill="#fdcb6e" font-size="12" text-anchor="middle" font-weight="600">RuleEngine</text><text x="470" y="84" fill="#5a5e73" font-size="10" text-anchor="middle">threshold alerts</text>'+
    '<rect x="390" y="170" width="160" height="56" rx="8" fill="#242736" stroke="#6c5ce7" stroke-width="2"/><text x="470" y="194" fill="#a29bfe" font-size="12" text-anchor="middle" font-weight="700">WearableAgent</text><text x="470" y="212" fill="#5a5e73" font-size="10" text-anchor="middle">LangGraph ReAct + LLM</text>'+
    '<rect x="390" y="282" width="160" height="56" rx="8" fill="#242736" stroke="#fd79a8" stroke-width="1.5"/><text x="470" y="306" fill="#fd79a8" font-size="12" text-anchor="middle" font-weight="600">AffectPipeline</text><text x="470" y="324" fill="#5a5e73" font-size="10" text-anchor="middle">arousal / stress / valence</text>'+
    '<rect x="574" y="152" width="130" height="90" rx="8" fill="#242736" stroke="#2e3245" stroke-width="1"/><text x="639" y="170" fill="#8b8fa3" font-size="9" text-anchor="middle" font-weight="600" letter-spacing=".06em">AGENT TOOLS</text><text x="639" y="186" fill="#5a5e73" font-size="9" text-anchor="middle">get_latest_readings</text><text x="639" y="198" fill="#5a5e73" font-size="9" text-anchor="middle">analyse_metric</text><text x="639" y="210" fill="#5a5e73" font-size="9" text-anchor="middle">compare_metrics</text><text x="639" y="222" fill="#5a5e73" font-size="9" text-anchor="middle">get_affective_state</text><text x="639" y="234" fill="#5a5e73" font-size="9" text-anchor="middle">+ more\u2026</text><line x1="550" y1="198" x2="574" y2="198" stroke="#6c5ce7" stroke-width="1" stroke-dasharray="3,3"/>'+
    '<line x1="550" y1="70" x2="720" y2="70" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/><line x1="550" y1="310" x2="620" y2="310" stroke="#2e3245" stroke-width="1.5" marker-end="url(#arrow)"/>'+
    '<text x="785" y="30" fill="#8b8fa3" font-size="11" text-anchor="middle" font-weight="600" letter-spacing=".08em">OUTPUTS</text>'+
    '<rect x="720" y="42" width="130" height="44" rx="8" fill="#242736" stroke="#e17055" stroke-width="1.5"/><text x="785" y="60" fill="#e17055" font-size="11" text-anchor="middle" font-weight="600">Alerts</text><text x="785" y="76" fill="#5a5e73" font-size="9" text-anchor="middle">NotificationDispatcher</text>'+
    '<rect x="620" y="280" width="130" height="56" rx="8" fill="#242736" stroke="#00cec9" stroke-width="1.5"/><text x="685" y="304" fill="#00cec9" font-size="11" text-anchor="middle" font-weight="600">SQLite DB</text><text x="685" y="320" fill="#5a5e73" font-size="9" text-anchor="middle">readings / alerts / affect</text>'+
    '<rect x="720" y="360" width="130" height="44" rx="8" fill="#242736" stroke="#fd79a8" stroke-width="1.5"/><text x="785" y="378" fill="#fd79a8" font-size="11" text-anchor="middle" font-weight="600">WebSocket</text><text x="785" y="394" fill="#5a5e73" font-size="9" text-anchor="middle">\u2192 Flutter App</text>'+
    '<line x1="685" y1="336" x2="720" y2="370" stroke="#2e3245" stroke-width="1" marker-end="url(#arrow)"/>'+
    '<rect x="20" y="260" width="120" height="44" rx="8" fill="#242736" stroke="#a29bfe" stroke-width="1.5"/><text x="80" y="287" fill="#a29bfe" font-size="12" text-anchor="middle" font-weight="600">FastAPI</text><text x="80" y="298" fill="#5a5e73" font-size="9" text-anchor="middle">REST + WS server</text>'+
    '<rect x="20" y="320" width="120" height="44" rx="8" fill="#242736" stroke="#00b894" stroke-width="1.5"/><text x="80" y="347" fill="#00b894" font-size="12" text-anchor="middle" font-weight="600">Scheduler</text><text x="80" y="358" fill="#5a5e73" font-size="9" text-anchor="middle">periodic collection</text>'+
    '<line x1="140" y1="340" x2="200" y2="145" stroke="#2e3245" stroke-width="1" stroke-dasharray="3,3" marker-end="url(#arrow)"/>'+
    '<defs><marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#5a5e73"/></marker></defs></svg>';
}

// ── Init ──────────────────────────────────────
connectWS();
refreshOverview();
refreshComponents();
loadRules();
loadToolsInventory();
loadLifeSnapsParticipants();
pollServerStreamStats();

setInterval(refreshOverview, 15000);
setInterval(refreshComponents, 10000);
</script>
</body>
</html>
